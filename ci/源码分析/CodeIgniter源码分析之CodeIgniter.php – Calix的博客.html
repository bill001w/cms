<!DOCTYPE html>
<!-- saved from url=(0071)http://calixwu.com/2014/11/codeigniter-yuanmafenxi-codeigniter-php.html -->
<html><style type="text/css" id="89039330005"></style><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=10,IE=9,IE=8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
<title>CodeIgniter源码分析之CodeIgniter.php – Calix的博客</title>
<script>
window._deel = {name: 'Calix',url: 'http://calixwu.com/wp-content/themes/yusi1.0', ajaxpager: '', commenton: 1, roll: [0,0]}
</script>
<meta name="author" content="calix,吴国清,calixwu">
<link rel="stylesheet" id="style-css" href="./CodeIgniter源码分析之CodeIgniter.php – Calix的博客_files/style.css" type="text/css" media="all">
<script type="text/javascript" src="./CodeIgniter源码分析之CodeIgniter.php – Calix的博客_files/jquery.min.js"></script>
<script type="text/javascript" src="./CodeIgniter源码分析之CodeIgniter.php – Calix的博客_files/jquery.js"></script>
<link rel="prev" title="CodeIgniter源码分析之Common.php" href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-common-php.html">
<link rel="next" title="CodeIgniter源码分析之index.php" href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-index-php.html">
<link rel="canonical" href="./CodeIgniter源码分析之CodeIgniter.php – Calix的博客_files/CodeIgniter源码分析之CodeIgniter.php – Calix的博客.html">
<link rel="shortlink" href="http://calixwu.com/?p=37">
<meta name="keywords" content="CodeIgniter, MVC, 框架, 源码分析, CodeIgniter">
<meta name="description" content="作者：Calix &lt;?php  if ( ! defined(&#39;BASEPATH&#39;)) exit(&#39;No direct script access allowed&#39;); /**  * 上面：  * 这个BASEPATH，就是在入口文件(index.php)里面定义的那个BASEPATH～  * 如果没有定义BASEPATH，那么直接退出，下面程序都不执行。其实除了入口文件index.php开头没有这句话之外，所有文件都会有这句话 ">
<style type="text/css" id="syntaxhighlighteranchor"></style>
<!--[if lt IE 9]><script src="http://calixwu.com/wp-content/themes/yusi1.0/js/html5.js"></script><![endif]-->
<script src="./CodeIgniter源码分析之CodeIgniter.php – Calix的博客_files/share.js"></script><link href="./CodeIgniter源码分析之CodeIgniter.php – Calix的博客_files/share.css" rel="styleSheet" type="text/css"></head>
<body class="single single-post postid-37 single-format-standard">

<header id="header" class="header">
<div class="container-inner">
 <div class="yusi-logo">
                    <a href="http://calixwu.com/">
                        <h1>
                                                        <span class="yusi-mono">Calix</span>
                                                        <span class="yusi-bloger">善于总结。</span>
                                                    </h1>
                    </a>
    </div>
</div>

	<div id="nav-header" class="navbar">
		
		<ul class="nav">
			<li id="menu-item-4" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-4"><a href="http://calixwu.com/">首页</a></li>
<li style="float:right;">
                    <div class="toggle-search"><i class="fa fa-search"></i></div>
<div class="search-expand" style="display: none;"><div class="search-expand-inner"><form method="get" class="searchform themeform" onsubmit="location.href=&#39;http://calixwu.com/search/&#39; + encodeURIComponent(this.s.value).replace(/%20/g, &#39;+&#39;); return false;" action="http://calixwu.com/"><div> <input type="ext" class="search" name="s" onblur="if(this.value==&#39;&#39;)this.value=&#39;search...&#39;;" onfocus="if(this.value==&#39;search...&#39;)this.value=&#39;&#39;;" value="search..."></div></form></div></div>
</li>
		</ul><div class="screen-mini"><button data-type="screen-nav" class="btn btn-inverse screen-nav"><i class="fa fa-list"></i></button></div>
	</div>
</header>
<section class="container"><div class="speedbar">
				<div class="toptip"><strong class="text-success"><i class="fa fa-volume-up"></i> </strong> </div>
	</div>
	<div class="content-wrap">
	<div class="content">

				<header class="article-header">
			<h1 class="article-title"><a href="./CodeIgniter源码分析之CodeIgniter.php – Calix的博客_files/CodeIgniter源码分析之CodeIgniter.php – Calix的博客.html">CodeIgniter源码分析之CodeIgniter.php</a></h1>
			<div class="meta">
				<span id="mute-category" class="muted"><i class="fa fa-list-alt"></i><a href="http://calixwu.com/category/codeigniter"> CodeIgniter</a></span>				<!--
				<span class="muted"><i class="fa fa-user"></i> <a href="http://calixwu.com/author/calix">calix</a></span>-->
				<time class="muted"><i class="fa fa-clock-o"></i> 2年前 (2014-11-19)</time>
				<span class="muted" style="color:#dd6666"><i class="fa fa-eye"></i> 2346℃</span>
											</div>
		</header>
		<article class="article-content">
			<p>作者：<a href="http://calixwu.com/" data-original-title="" title="">Calix</a></p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="pun">&lt;?</span><span class="pln">php  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> </span><span class="kwd">defined</span><span class="pun">(</span><span class="str">'BASEPATH'</span><span class="pun">))</span><span class="pln"> </span><span class="kwd">exit</span><span class="pun">(</span><span class="str">'No direct script access allowed'</span><span class="pun">);</span></li><li class="L1"><span class="com">/**</span></li><li class="L2"><span class="com"> * 上面：</span></li><li class="L3"><span class="com"> * 这个BASEPATH，就是在入口文件(index.php)里面定义的那个BASEPATH～</span></li><li class="L4"><span class="com"> * 如果没有定义BASEPATH，那么直接退出，下面程序都不执行。其实除了入口文件index.php开头没有这句话之外，所有文件都会有这句话</span></li><li class="L5"><span class="com"> * 也就是说，所有文件都不能单独运行，一定是index.php在运行过程中把这些文件通</span></li><li class="L6"><span class="com"> * 过某种方式引进来运行，所以只有入口文件index.php才能被访问。</span></li><li class="L7"><span class="com"> * </span></li><li class="L8"><span class="com"> */</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">/**</span></li><li class="L1"><span class="com"> * CodeIgniter</span></li><li class="L2"><span class="com"> *</span></li><li class="L3"><span class="com"> */</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/**</span></li><li class="L6"><span class="com"> * 弱弱地建议：</span></li><li class="L7"><span class="com"> *  其实把CodeIgniter.php这个文件的代码运行一次，就是整个CI应用都完成了一次完整的运作流程了。</span></li><li class="L8"><span class="com"> *  其中会加载一些组件，引入很多外部文件，等等。所以建议在阅读此文件代码的时候，第一遍先阅读它的</span></li><li class="L9"><span class="com"> *  大概流程，也就是说不必进入相应的组件、函数文件中去。第二遍看的时候才具体看那些函数、组件里面是怎</span></li><li class="L0"><span class="com"> *  么实现的。当然要看个人需要咯～</span></li><li class="L1"><span class="com"> *  </span></li><li class="L2"><span class="com"> */</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">// ------------------------------------------------------------------------</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">/**</span></li><li class="L7"><span class="com"> * System Initialization File</span></li><li class="L8"><span class="com"> */</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">/**</span></li><li class="L1"><span class="com"> * CodeIgniter Version</span></li><li class="L2"><span class="com"> *</span></li><li class="L3"><span class="com"> * @var string</span></li><li class="L4"><span class="com"> *</span></li><li class="L5"><span class="com"> */</span></li><li class="L6"><span class="pln"> define</span><span class="pun">(</span><span class="str">'CI_VERSION'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'2.1.2'</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/**</span></li><li class="L9"><span class="com"> * CodeIgniter Branch (Core = TRUE, Reactor = FALSE)</span></li><li class="L0"><span class="com"> *</span></li><li class="L1"><span class="com"> * @var boolean</span></li><li class="L2"><span class="com"> *</span></li><li class="L3"><span class="com"> */</span></li><li class="L4"><span class="pln"> define</span><span class="pun">(</span><span class="str">'CI_CORE'</span><span class="pun">,</span><span class="pln"> FALSE</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">/*</span></li><li class="L7"><span class="com"> * ------------------------------------------------------</span></li><li class="L8"><span class="com"> *  Load the global functions</span></li><li class="L9"><span class="com"> * ------------------------------------------------------</span></li><li class="L0"><span class="com"> */</span></li><li class="L1"><span class="pln"> </span><span class="com">//在这里引入了很多全局函数。这些函数在整个应用运行的过程都是非常重要的。</span></li><li class="L2"><span class="pln">  </span><span class="com">//这些函数都是应该最先被引入，起码要先于下面的组件，为什么呢？详见core/Common.php，建议在这个地方先略过。</span></li><li class="L3"><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="pln">BASEPATH</span><span class="pun">.</span><span class="str">'core/Common.php'</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/*</span></li><li class="L6"><span class="com"> * ------------------------------------------------------</span></li><li class="L7"><span class="com"> *  Load the framework constants</span></li><li class="L8"><span class="com"> * ------------------------------------------------------</span></li><li class="L9"><span class="com"> */</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="pln"> </span><span class="com">//加载配置的常量。这个配置文件里面默认已经有一些和文件有关的常量。</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln"> </span><span class="com">//下面这个判断可以看出一开始我们在index.php里面定义的那个ENVIRONMENT的作用之一，如果是定义某个环境，</span></li><li class="L4"><span class="pln"> </span><span class="com">//会调用相应的配置文件，这样就可以使得应用在相应的环境中运行。不仅仅是这个常量的配置文件是这样子，</span></li><li class="L5"><span class="pln"> </span><span class="com">//以后你会发现，其实全部配置文件都是先判断当前环境再引入。</span></li><li class="L6"><span class="pln"> </span><span class="com">//方便切换，只需在index.php里面改一下ENVIRONMENT的值。</span></li><li class="L7"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">defined</span><span class="pun">(</span><span class="str">'ENVIRONMENT'</span><span class="pun">)</span><span class="pln"> AND file_exists</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">.</span><span class="str">'config/'</span><span class="pun">.</span><span class="pln">ENVIRONMENT</span><span class="pun">.</span><span class="str">'/constants.php'</span><span class="pun">))</span></li><li class="L8"><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">  </span><span class="kwd">require</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">.</span><span class="str">'config/'</span><span class="pun">.</span><span class="pln">ENVIRONMENT</span><span class="pun">.</span><span class="str">'/constants.php'</span><span class="pun">);</span></li><li class="L0"><span class="pln"> </span><span class="pun">}</span></li><li class="L1"><span class="pln"> </span><span class="kwd">else</span></li><li class="L2"><span class="pln"> </span><span class="pun">{</span></li><li class="L3"><span class="pln">  </span><span class="com">//当然啦，如果压根没有这个环境下的配置文件，就会调用默认的。CI手册上也有说，各种环境下的相同的配置文件，可以直接放在</span></li><li class="L4"><span class="pln">  </span><span class="com">//config/下，而不需要每个环境的目录下都有。</span></li><li class="L5"><span class="pln">  </span><span class="kwd">require</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">.</span><span class="str">'config/constants.php'</span><span class="pun">);</span></li><li class="L6"><span class="pln"> </span><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/*</span></li><li class="L9"><span class="com"> * ------------------------------------------------------</span></li><li class="L0"><span class="com"> *  Define a custom error handler so we can log PHP errors</span></li><li class="L1"><span class="com"> * ------------------------------------------------------</span></li><li class="L2"><span class="com"> */</span></li><li class="L3"><span class="pln"> </span><span class="com">//这里是把错误的处理交给_exception_handler这个函数来做，是在core/Common.php文件中定义的全局函数。</span></li><li class="L4"><span class="pln">  </span><span class="com">//具体请看core/Common.php。</span></li><li class="L5"><span class="pln"> set_error_handler</span><span class="pun">(</span><span class="str">'_exception_handler'</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> is_php</span><span class="pun">(</span><span class="str">'5.3'</span><span class="pun">))</span></li><li class="L8"><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">  </span><span class="com">//这个magic_quotes就是会自动把那些由$_GET,$_POST等传过来的值进行处理，加\。</span></li><li class="L0"><span class="pln">  </span><span class="com">//这个东西最好不要打开，虽然某些时候会帮到忙，不过过滤、转义等处理最后还是手动做好一些。</span></li><li class="L1"><span class="pln">  </span><span class="com">//php5.3以上默认是把这个东西关掉的(linux下/etc/php.ini里面)。这个东西本来就不应该有。</span></li><li class="L2"><span class="pln">  </span><span class="lit">@set_magic_quotes_runtime</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln"> </span><span class="com">// Kill magic quotes</span></li><li class="L3"><span class="pln"> </span><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/*</span></li><li class="L6"><span class="com"> * ------------------------------------------------------</span></li><li class="L7"><span class="com"> *  Set the subclass_prefix</span></li><li class="L8"><span class="com"> * ------------------------------------------------------</span></li><li class="L9"><span class="com"> *</span></li><li class="L0"><span class="com"> */</span></li><li class="L1"><span class="pln"> </span><span class="com">/**</span></li><li class="L2"><span class="com">  * 这个subclass_prefix是什么？</span></li><li class="L3"><span class="com">  * 这是一个非常棒的东西！！有了它我们就可以轻易扩展CI框架～</span></li><li class="L4"><span class="com">  * 具体core/Common.php 中的load_class()</span></li><li class="L5"><span class="com">  */</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$assign_to_config</span><span class="pun">[</span><span class="str">'subclass_prefix'</span><span class="pun">])</span><span class="pln"> AND $assign_to_config</span><span class="pun">[</span><span class="str">'subclass_prefix'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="str">''</span><span class="pun">)</span></li><li class="L8"><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">  </span><span class="com">//这个get_config($replace)就是从配置文件里面读取信息，这里是读取config/config.php中的配置信息</span></li><li class="L0"><span class="pln">  </span><span class="com">//这个参数$replace的作用是什么呢？就是临时把修改配置文件的意思，注意并没有从改变文件的值，这个改变只是</span></li><li class="L1"><span class="pln">  </span><span class="com">//停留在内存的层面上。</span></li><li class="L2"><span class="pln">  </span><span class="com">//而$assign_to_config['xxx'];是在index.php中定义的一个配置信息数组，这个配置数组要优先权要大于配置文件当中的。</span></li><li class="L3"><span class="pln">  </span><span class="com">//所以这个判断的作用是，看看有没有在index.php里面定义了 $assign_to_config['subclass_prefix']，如果有的话，</span></li><li class="L4"><span class="pln">  </span><span class="com">//就那把配置文件中的$config['subclass_prefix']的值改成这个。</span></li><li class="L5"><span class="pln">  get_config</span><span class="pun">(</span><span class="pln">array</span><span class="pun">(</span><span class="str">'subclass_prefix'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $assign_to_config</span><span class="pun">[</span><span class="str">'subclass_prefix'</span><span class="pun">]));</span></li><li class="L6"><span class="pln"> </span><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/*</span></li><li class="L9"><span class="com"> * ------------------------------------------------------</span></li><li class="L0"><span class="com"> *  Set a liberal script execution time limit</span></li><li class="L1"><span class="com"> *  上面这个'liberal'是“慷慨大方的”的意思 -_-||</span></li><li class="L2"><span class="com"> * ------------------------------------------------------</span></li><li class="L3"><span class="com"> */</span></li><li class="L4"><span class="pln"> </span><span class="com">//这个safe_mode也是php.ini里面的一个配置项目</span></li><li class="L5"><span class="pln"> </span><span class="com">//具体看：http://blog.163.com/wu_guoqing/blog/static/196537018201272710925363/</span></li><li class="L6"><span class="pln"> </span><span class="com">//这里主要是设置运行时间限制而已。</span></li><li class="L7"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">function_exists</span><span class="pun">(</span><span class="str">"set_time_limit"</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> TRUE AND </span><span class="lit">@ini_get</span><span class="pun">(</span><span class="str">"safe_mode"</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></li><li class="L8"><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">  </span><span class="lit">@set_time_limit</span><span class="pun">(</span><span class="lit">300</span><span class="pun">);</span></li><li class="L0"><span class="pln"> </span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">/*</span></li><li class="L3"><span class="com"> * ------------------------------------------------------</span></li><li class="L4"><span class="com"> *  Start the timer... tick tock tick tock...</span></li><li class="L5"><span class="com"> * ------------------------------------------------------</span></li><li class="L6"><span class="com"> */</span></li><li class="L7"><span class="pln"> </span><span class="com">//load_class()是用来加载类的，准确来说，是用来取得某个类的一个单一实例。</span></li><li class="L8"><span class="pln"> </span><span class="com">//像下来的调用就是返回system/core/Benchmark的一个实例。core里面的大都是CI的组件。</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="pln"> </span><span class="com">/**</span></li><li class="L1"><span class="com">  * Benchmark是基准点的意思。</span></li><li class="L2"><span class="com">  * 其实这个类的功能很简单，只是用来计算程序运行消耗的时间和内存而已。</span></li><li class="L3"><span class="com">  * 以后经常在某个地方冒出来句$BM-&gt;mark('xxx');这个作用就是记录运行到当前位置的时候的时间点。</span></li><li class="L4"><span class="com">  * 通过两个时间点，就可以计算出时间了。</span></li><li class="L5"><span class="com"> */</span></li><li class="L6"><span class="pln"> $BM </span><span class="pun">=&amp;</span><span class="pln"> load_class</span><span class="pun">(</span><span class="str">'Benchmark'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'core'</span><span class="pun">);</span></li><li class="L7"><span class="pln"> $BM</span><span class="pun">-&gt;</span><span class="pln">mark</span><span class="pun">(</span><span class="str">'total_execution_time_start'</span><span class="pun">);</span></li><li class="L8"><span class="pln"> $BM</span><span class="pun">-&gt;</span><span class="pln">mark</span><span class="pun">(</span><span class="str">'loading_time:_base_classes_start'</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">/*</span></li><li class="L1"><span class="com"> * ------------------------------------------------------</span></li><li class="L2"><span class="com"> *  Instantiate the hooks class</span></li><li class="L3"><span class="com"> * ------------------------------------------------------</span></li><li class="L4"><span class="com"> */</span></li><li class="L5"><span class="pln"> </span><span class="com">//取得Hooks组件。</span></li><li class="L6"><span class="pln"> </span><span class="com">/**</span></li><li class="L7"><span class="com">  * 这个hook也是非常非常棒的一个东西！它可以让我们很好地扩展和改造CI～</span></li><li class="L8"><span class="com">  * 可以这样理解，一个应用从运行到结束这个期间，CI为我们保留了一些位置，在这些位置上面可以让开发人员放上所谓的</span></li><li class="L9"><span class="com">  * “钩子”（其实就是一段程序啦！），在应用运行过程中，当运行到有可以放钩子的位置的时候，先检测开发人员有没有</span></li><li class="L0"><span class="com">  * 实现这里的钩子，如果有就运行它。</span></li><li class="L1"><span class="com">  * 有些地方甚至可以用自己写的钩子程序替代CI框架本来的程序。</span></li><li class="L2"><span class="com">  */</span></li><li class="L3"><span class="pln"> $EXT </span><span class="pun">=&amp;</span><span class="pln"> load_class</span><span class="pun">(</span><span class="str">'Hooks'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'core'</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/*</span></li><li class="L6"><span class="com"> * ------------------------------------------------------</span></li><li class="L7"><span class="com"> *  Is there a "pre_system" hook?</span></li><li class="L8"><span class="com"> * ------------------------------------------------------</span></li><li class="L9"><span class="com"> */</span></li><li class="L0"><span class="pln"> </span><span class="com">//这里就有一个钩子啦。大概意思是：整个应用系统开始动了，这里要不要先让开发人员来一段程序？</span></li><li class="L1"><span class="pln"> </span><span class="com">//如果你定义了pre_system这个钩子，那么，其实它就是在这个位置运行的。</span></li><li class="L2"><span class="pln"> $EXT</span><span class="pun">-&gt;</span><span class="pln">_call_hook</span><span class="pun">(</span><span class="str">'pre_system'</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/*</span></li><li class="L5"><span class="com"> * ------------------------------------------------------</span></li><li class="L6"><span class="com"> *  Instantiate the config class</span></li><li class="L7"><span class="com"> * ------------------------------------------------------</span></li><li class="L8"><span class="com"> */</span></li><li class="L9"><span class="pln"> </span><span class="com">//取得配置组件。</span></li><li class="L0"><span class="pln"> $CFG </span><span class="pun">=&amp;</span><span class="pln"> load_class</span><span class="pun">(</span><span class="str">'Config'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'core'</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln"> </span><span class="com">// Do we have any manually set config items in the index.php file?</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln"> </span><span class="com">//如果有在index.php定义配置数组，那么就丢给配置组件CFG，以后就由CFG来保管了配置信息了。</span></li><li class="L5"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$assign_to_config</span><span class="pun">))</span></li><li class="L6"><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">  $CFG</span><span class="pun">-&gt;</span><span class="pln">_assign_to_config</span><span class="pun">(</span><span class="pln">$assign_to_config</span><span class="pun">);</span></li><li class="L8"><span class="pln"> </span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">/*</span></li><li class="L1"><span class="com"> * ------------------------------------------------------</span></li><li class="L2"><span class="com"> *  Instantiate the UTF-8 class</span></li><li class="L3"><span class="com"> * ------------------------------------------------------</span></li><li class="L4"><span class="com"> *</span></li><li class="L5"><span class="com"> * </span></li><li class="L6"><span class="com"> */</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="pln"> </span><span class="com">//取得UTF－8组件，这里暂时不用管它。</span></li><li class="L9"><span class="pln"> $UNI </span><span class="pun">=&amp;</span><span class="pln"> load_class</span><span class="pun">(</span><span class="str">'Utf8'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'core'</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">/*</span></li><li class="L2"><span class="com"> * ------------------------------------------------------</span></li><li class="L3"><span class="com"> *  Instantiate the URI class</span></li><li class="L4"><span class="com"> * ------------------------------------------------------</span></li><li class="L5"><span class="com"> */</span></li><li class="L6"><span class="pln"> </span><span class="com">//取得URI组件。</span></li><li class="L7"><span class="pln"> $URI </span><span class="pun">=&amp;</span><span class="pln"> load_class</span><span class="pun">(</span><span class="str">'URI'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'core'</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">/*</span></li><li class="L0"><span class="com"> * ------------------------------------------------------</span></li><li class="L1"><span class="com"> *  Instantiate the routing class and set the routing</span></li><li class="L2"><span class="com"> * ------------------------------------------------------</span></li><li class="L3"><span class="com"> */</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="pln"> </span><span class="com">//取得URI的好基友RTR</span></li><li class="L6"><span class="pln"> $RTR </span><span class="pun">=&amp;</span><span class="pln"> load_class</span><span class="pun">(</span><span class="str">'Router'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'core'</span><span class="pun">);</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="pln"> </span><span class="com">//RTR的这个_set_routing();其实做了非常多的事情。。详见core/Router.php。非常重要。</span></li><li class="L9"><span class="pln"> $RTR</span><span class="pun">-&gt;</span><span class="pln">_set_routing</span><span class="pun">();</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln"> </span><span class="com">// Set any routing overrides that may exist in the main index file</span></li><li class="L2"><span class="pln"> </span><span class="com">//</span></li><li class="L3"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$routing</span><span class="pun">))</span></li><li class="L4"><span class="pln"> </span><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="com">//这个$routing是在index.php入口文件中可以配置的一个数组。这里起到路由覆盖的作用。</span></li><li class="L6"><span class="pln">  </span><span class="com">//index.php里面配置的信息永远都是最优先的。</span></li><li class="L7"><span class="pln">  </span><span class="com">//在这里无论你请求的路由是什么，只要有配置$routing（当然要配对），就会被它重定向。</span></li><li class="L8"><span class="pln">  </span><span class="com">//所以我觉得这句话放在这个地方有点坑，上面_set_routing搞了那么久，一下子就被覆盖掉了。</span></li><li class="L9"><span class="pln">  $RTR</span><span class="pun">-&gt;</span><span class="pln">_set_overrides</span><span class="pun">(</span><span class="pln">$routing</span><span class="pun">);</span></li><li class="L0"><span class="pln"> </span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">/*</span></li><li class="L3"><span class="com"> * ------------------------------------------------------</span></li><li class="L4"><span class="com"> *  Instantiate the output class</span></li><li class="L5"><span class="com"> * ------------------------------------------------------</span></li><li class="L6"><span class="com"> */</span></li><li class="L7"><span class="pln"> </span><span class="com">//输出组件。这个输出组件有什么用？输出不是$this-&gt;load-&gt;view()么？其实它们两个也是好基友。</span></li><li class="L8"><span class="pln"> </span><span class="com">//详见：core/Output.php core/Loader.php</span></li><li class="L9"><span class="pln"> $OUT </span><span class="pun">=&amp;</span><span class="pln"> load_class</span><span class="pun">(</span><span class="str">'Output'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'core'</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">/*</span></li><li class="L2"><span class="com"> * ------------------------------------------------------</span></li><li class="L3"><span class="com"> * Is there a valid cache file?  If so, we're done...</span></li><li class="L4"><span class="com"> * ------------------------------------------------------</span></li><li class="L5"><span class="com"> */</span></li><li class="L6"><span class="pln"> </span><span class="com">//下面是输出缓存的处理，这里允许我们自己写个hook来取替代CI原来Output类的缓存输出。</span></li><li class="L7"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$EXT</span><span class="pun">-&gt;</span><span class="pln">_call_hook</span><span class="pun">(</span><span class="str">'cache_override'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">===</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L8"><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$OUT</span><span class="pun">-&gt;</span><span class="pln">_display_cache</span><span class="pun">(</span><span class="pln">$CFG</span><span class="pun">,</span><span class="pln"> $URI</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> TRUE</span><span class="pun">)</span></li><li class="L0"><span class="pln">  </span><span class="pun">{</span></li><li class="L1"><span class="pln">   </span><span class="kwd">exit</span><span class="pun">;</span><span class="com">//如果可以输出缓存，那么就没有必要再做其它事了。输出结果后直接退出。</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span></li><li class="L3"><span class="pln"> </span><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/*</span></li><li class="L6"><span class="com"> * -----------------------------------------------------</span></li><li class="L7"><span class="com"> * Load the security class for xss and csrf support</span></li><li class="L8"><span class="com"> * -----------------------------------------------------</span></li><li class="L9"><span class="com"> */</span></li><li class="L0"><span class="pln"> </span><span class="com">//取得安全组件（安全组件暂时不详讲，因为对于CI一个运作流程来说，它不是必要的。CI的安全处理以后会作为一个新话题来探讨）</span></li><li class="L1"><span class="pln"> $SEC </span><span class="pun">=&amp;</span><span class="pln"> load_class</span><span class="pun">(</span><span class="str">'Security'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'core'</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">/*</span></li><li class="L4"><span class="com"> * ------------------------------------------------------</span></li><li class="L5"><span class="com"> *  Load the Input class and sanitize globals</span></li><li class="L6"><span class="com"> * ------------------------------------------------------</span></li><li class="L7"><span class="com"> */</span></li><li class="L8"><span class="pln"> </span><span class="com">//取得安全组件的好基友INPUT组件。（主要是结合安全组件作一些输入方面的安全处理，$this-&gt;input-&gt;post()这些常用的操作都是</span></li><li class="L9"><span class="pln"> </span><span class="com">//由它们两个负责的。）</span></li><li class="L0"><span class="pln"> $IN </span><span class="pun">=&amp;</span><span class="pln"> load_class</span><span class="pun">(</span><span class="str">'Input'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'core'</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">/*</span></li><li class="L3"><span class="com"> * ------------------------------------------------------</span></li><li class="L4"><span class="com"> *  Load the Language class</span></li><li class="L5"><span class="com"> * ------------------------------------------------------</span></li><li class="L6"><span class="com"> */</span></li><li class="L7"><span class="pln"> </span><span class="com">//语言组件。</span></li><li class="L8"><span class="pln"> $LANG </span><span class="pun">=&amp;</span><span class="pln"> load_class</span><span class="pun">(</span><span class="str">'Lang'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'core'</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">/*</span></li><li class="L1"><span class="com"> * ------------------------------------------------------</span></li><li class="L2"><span class="com"> *  Load the app controller and local controller</span></li><li class="L3"><span class="com"> * ------------------------------------------------------</span></li><li class="L4"><span class="com"> *</span></li><li class="L5"><span class="com"> */</span></li><li class="L6"><span class="pln"> </span><span class="com">//引入控制器父类文件。这里和其它组件的引入方式不一样，用load_class();因为我们最终用到的并不是这个父类，</span></li><li class="L7"><span class="pln"> </span><span class="com">//而是我们自己写在application/controllers/下的某个由uri请求的控制器。</span></li><li class="L8"><span class="pln"> </span><span class="kwd">require</span><span class="pln"> BASEPATH</span><span class="pun">.</span><span class="str">'core/Controller.php'</span><span class="pun">;</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln"> </span><span class="com">//定义get_instance();方法，通过调用CI_Controller::get_instance()可以实现单例化，</span></li><li class="L1"><span class="pln"> </span><span class="com">//调用此函数可方便以后直接取得当前应用控制器。</span></li><li class="L2"><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">get_instance</span><span class="pun">()</span></li><li class="L3"><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> CI_Controller</span><span class="pun">::</span><span class="pln">get_instance</span><span class="pun">();</span></li><li class="L5"><span class="pln"> </span><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln"> </span><span class="com">//和其它组件一样，控制器父类同样可以通过前缀的方式进行扩展。</span></li><li class="L9"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">file_exists</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">.</span><span class="str">'core/'</span><span class="pun">.</span><span class="pln">$CFG</span><span class="pun">-&gt;</span><span class="pln">config</span><span class="pun">[</span><span class="str">'subclass_prefix'</span><span class="pun">].</span><span class="str">'Controller.php'</span><span class="pun">))</span></li><li class="L0"><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">  </span><span class="kwd">require</span><span class="pln"> APPPATH</span><span class="pun">.</span><span class="str">'core/'</span><span class="pun">.</span><span class="pln">$CFG</span><span class="pun">-&gt;</span><span class="pln">config</span><span class="pun">[</span><span class="str">'subclass_prefix'</span><span class="pun">].</span><span class="str">'Controller.php'</span><span class="pun">;</span></li><li class="L2"><span class="pln"> </span><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> file_exists</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">.</span><span class="str">'controllers/'</span><span class="pun">.</span><span class="pln">$RTR</span><span class="pun">-&gt;</span><span class="pln">fetch_directory</span><span class="pun">().</span><span class="pln">$RTR</span><span class="pun">-&gt;</span><span class="pln">fetch_class</span><span class="pun">().</span><span class="str">'.php'</span><span class="pun">))</span></li><li class="L5"><span class="pln"> </span><span class="pun">{</span></li><li class="L6"><span class="pln">  </span><span class="com">//其实如果能够进入这里，说明了上面的$RTR-&gt;_set_routing();在_validate_request()的时候一定是在请求默认控制器。</span></li><li class="L7"><span class="pln">  </span><span class="com">//详见：core/Router.php</span></li><li class="L8"><span class="pln">  show_error</span><span class="pun">(</span><span class="str">'Unable to load your default controller. Please make sure the controller specified in your Routes.php file is valid.'</span><span class="pun">);</span></li><li class="L9"><span class="pln"> </span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln"> </span><span class="com">//引入我们最终确认的应用控制器。</span></li><li class="L2"><span class="pln"> include</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">.</span><span class="str">'controllers/'</span><span class="pun">.</span><span class="pln">$RTR</span><span class="pun">-&gt;</span><span class="pln">fetch_directory</span><span class="pun">().</span><span class="pln">$RTR</span><span class="pun">-&gt;</span><span class="pln">fetch_class</span><span class="pun">().</span><span class="str">'.php'</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln"> $BM</span><span class="pun">-&gt;</span><span class="pln">mark</span><span class="pun">(</span><span class="str">'loading_time:_base_classes_end'</span><span class="pun">);</span><span class="com">//这里mark一下，说明CI的所需要的基本的类都加载完了。</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">/*</span></li><li class="L7"><span class="com"> * ------------------------------------------------------</span></li><li class="L8"><span class="com"> *  Security check</span></li><li class="L9"><span class="com"> * ------------------------------------------------------</span></li><li class="L0"><span class="com"> *</span></li><li class="L1"><span class="com"> *  下面主要进行一些方法上的验证。</span></li><li class="L2"><span class="com"> *  因为毕竟我们是通过URI直接调用控制器里面的方法的，其实这是个很危险的事情。</span></li><li class="L3"><span class="com"> *  必须要保证我们原本没想过要通过URI访问的方法不能访问。</span></li><li class="L4"><span class="com"> *  </span></li><li class="L5"><span class="com"> *  CI里面规定以_下划线开头的方法，一般是作为非公开的方法，即使方法定义为public。</span></li><li class="L6"><span class="com"> *  其实不仅仅是CI这么做，把非公开的方法名以_开头，是很好的一种规范。</span></li><li class="L7"><span class="com"> *  第二个就是父类CI_Controller里面的方法也是不允许通过URI访问的。</span></li><li class="L8"><span class="com"> *  如果URI请求这样的方法，那么会作为404处理。</span></li><li class="L9"><span class="com"> */</span></li><li class="L0"><span class="pln"> $class  </span><span class="pun">=</span><span class="pln"> $RTR</span><span class="pun">-&gt;</span><span class="pln">fetch_class</span><span class="pun">();</span></li><li class="L1"><span class="pln"> $method </span><span class="pun">=</span><span class="pln"> $RTR</span><span class="pun">-&gt;</span><span class="pln">fetch_method</span><span class="pun">();</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> class_exists</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">)</span></li><li class="L4"><span class="pln">  OR strncmp</span><span class="pun">(</span><span class="pln">$method</span><span class="pun">,</span><span class="pln"> </span><span class="str">'_'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span></li><li class="L5"><span class="pln">  OR in_array</span><span class="pun">(</span><span class="pln">strtolower</span><span class="pun">(</span><span class="pln">$method</span><span class="pun">),</span><span class="pln"> array_map</span><span class="pun">(</span><span class="str">'strtolower'</span><span class="pun">,</span><span class="pln"> get_class_methods</span><span class="pun">(</span><span class="str">'CI_Controller'</span><span class="pun">)))</span></li><li class="L6"><span class="pln">  </span><span class="pun">)</span></li><li class="L7"><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> empty</span><span class="pun">(</span><span class="pln">$RTR</span><span class="pun">-&gt;</span><span class="pln">routes</span><span class="pun">[</span><span class="str">'404_override'</span><span class="pun">]))</span></li><li class="L9"><span class="pln">  </span><span class="pun">{</span></li><li class="L0"><span class="pln">   $x </span><span class="pun">=</span><span class="pln"> explode</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">,</span><span class="pln"> $RTR</span><span class="pun">-&gt;</span><span class="pln">routes</span><span class="pun">[</span><span class="str">'404_override'</span><span class="pun">]);</span></li><li class="L1"><span class="pln">   $class </span><span class="pun">=</span><span class="pln"> $x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">];</span></li><li class="L2"><span class="pln">   $method </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> $x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="str">'index'</span><span class="pun">);</span></li><li class="L3"><span class="pln">   </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> class_exists</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">))</span></li><li class="L4"><span class="pln">   </span><span class="pun">{</span></li><li class="L5"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> file_exists</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">.</span><span class="str">'controllers/'</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">))</span></li><li class="L6"><span class="pln">    </span><span class="pun">{</span></li><li class="L7"><span class="pln">     show_404</span><span class="pun">(</span><span class="str">"{$class}/{$method}"</span><span class="pun">);</span></li><li class="L8"><span class="pln">    </span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">    include_once</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">.</span><span class="str">'controllers/'</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">);</span></li><li class="L1"><span class="pln">   </span><span class="pun">}</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span></li><li class="L3"><span class="pln">  </span><span class="kwd">else</span></li><li class="L4"><span class="pln">  </span><span class="pun">{</span></li><li class="L5"><span class="pln">   show_404</span><span class="pun">(</span><span class="str">"{$class}/{$method}"</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="pun">}</span></li><li class="L7"><span class="pln"> </span><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">/*</span></li><li class="L0"><span class="com"> * ------------------------------------------------------</span></li><li class="L1"><span class="com"> *  Is there a "pre_controller" hook?</span></li><li class="L2"><span class="com"> * ------------------------------------------------------</span></li><li class="L3"><span class="com"> */</span></li><li class="L4"><span class="pln"> </span><span class="com">//这里又一个钩子，这个钩子的位置往往都是在一些特殊的位置的，像这里就是发生在实例化控制器前。</span></li><li class="L5"><span class="pln"> $EXT</span><span class="pun">-&gt;</span><span class="pln">_call_hook</span><span class="pun">(</span><span class="str">'pre_controller'</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">/*</span></li><li class="L8"><span class="com"> * ------------------------------------------------------</span></li><li class="L9"><span class="com"> *  Instantiate the requested controller</span></li><li class="L0"><span class="com"> * ------------------------------------------------------</span></li><li class="L1"><span class="com"> */</span></li><li class="L2"><span class="pln"> </span><span class="com">// Mark a start point so we can benchmark the controller</span></li><li class="L3"><span class="pln"> $BM</span><span class="pun">-&gt;</span><span class="pln">mark</span><span class="pun">(</span><span class="str">'controller_execution_time_( '</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">.</span><span class="str">' / '</span><span class="pun">.</span><span class="pln">$method</span><span class="pun">.</span><span class="str">' )_start'</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln"> $CI </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> $class</span><span class="pun">();</span><span class="com">//折腾了这么久，终于实例化我们想要的控制器了。。。。。。。。。。。。。。。。。。。。。</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">/*</span></li><li class="L8"><span class="com"> * ------------------------------------------------------</span></li><li class="L9"><span class="com"> *  Is there a "post_controller_constructor" hook?</span></li><li class="L0"><span class="com"> * ------------------------------------------------------</span></li><li class="L1"><span class="com"> */</span></li><li class="L2"><span class="pln"> $EXT</span><span class="pun">-&gt;</span><span class="pln">_call_hook</span><span class="pun">(</span><span class="str">'post_controller_constructor'</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/*</span></li><li class="L5"><span class="com"> * ------------------------------------------------------</span></li><li class="L6"><span class="com"> *  Call the requested method</span></li><li class="L7"><span class="com"> * ------------------------------------------------------</span></li><li class="L8"><span class="com"> */</span></li><li class="L9"><span class="pln"> </span><span class="com">// Is there a "remap" function? If so, we call it instead</span></li><li class="L0"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">method_exists</span><span class="pun">(</span><span class="pln">$CI</span><span class="pun">,</span><span class="pln"> </span><span class="str">'_remap'</span><span class="pun">))</span></li><li class="L1"><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="com">//这个_remap也是一个非常棒的东西！如果有定义，它会优先被调用，在这个方法里面我们可以根据$method和参数，随意</span></li><li class="L3"><span class="pln">  </span><span class="com">//做任何处理和加工。即使那个$method不存在。</span></li><li class="L4"><span class="pln">  $CI</span><span class="pun">-&gt;</span><span class="pln">_remap</span><span class="pun">(</span><span class="pln">$method</span><span class="pun">,</span><span class="pln"> array_slice</span><span class="pun">(</span><span class="pln">$URI</span><span class="pun">-&gt;</span><span class="pln">rsegments</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">));</span></li><li class="L5"><span class="pln"> </span><span class="pun">}</span></li><li class="L6"><span class="pln"> </span><span class="kwd">else</span></li><li class="L7"><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln">  </span><span class="com">//如果请求的方法不存在，那么就按404处理。</span></li><li class="L0"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> in_array</span><span class="pun">(</span><span class="pln">strtolower</span><span class="pun">(</span><span class="pln">$method</span><span class="pun">),</span><span class="pln"> array_map</span><span class="pun">(</span><span class="str">'strtolower'</span><span class="pun">,</span><span class="pln"> get_class_methods</span><span class="pun">(</span><span class="pln">$CI</span><span class="pun">))))</span></li><li class="L1"><span class="pln">  </span><span class="pun">{</span></li><li class="L2"><span class="pln">   </span><span class="com">// Check and see if we are using a 404 override and use it.</span></li><li class="L3"><span class="pln">   </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> empty</span><span class="pun">(</span><span class="pln">$RTR</span><span class="pun">-&gt;</span><span class="pln">routes</span><span class="pun">[</span><span class="str">'404_override'</span><span class="pun">]))</span></li><li class="L4"><span class="pln">   </span><span class="pun">{</span></li><li class="L5"><span class="pln">    $x </span><span class="pun">=</span><span class="pln"> explode</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">,</span><span class="pln"> $RTR</span><span class="pun">-&gt;</span><span class="pln">routes</span><span class="pun">[</span><span class="str">'404_override'</span><span class="pun">]);</span></li><li class="L6"><span class="pln">    $class </span><span class="pun">=</span><span class="pln"> $x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">];</span></li><li class="L7"><span class="pln">    $method </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> $x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="str">'index'</span><span class="pun">);</span></li><li class="L8"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> class_exists</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">))</span></li><li class="L9"><span class="pln">    </span><span class="pun">{</span></li><li class="L0"><span class="pln">     </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> file_exists</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">.</span><span class="str">'controllers/'</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">))</span></li><li class="L1"><span class="pln">     </span><span class="pun">{</span></li><li class="L2"><span class="pln">      show_404</span><span class="pun">(</span><span class="str">"{$class}/{$method}"</span><span class="pun">);</span></li><li class="L3"><span class="pln">     </span><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">     include_once</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">.</span><span class="str">'controllers/'</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">);</span></li><li class="L6"><span class="pln">     unset</span><span class="pun">(</span><span class="pln">$CI</span><span class="pun">);</span><span class="com">//这里是把原来的控制器删掉，改用我们定义的404重定向的类。</span></li><li class="L7"><span class="pln">     $CI </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> $class</span><span class="pun">();</span></li><li class="L8"><span class="pln">    </span><span class="pun">}</span></li><li class="L9"><span class="pln">   </span><span class="pun">}</span></li><li class="L0"><span class="pln">   </span><span class="kwd">else</span></li><li class="L1"><span class="pln">   </span><span class="pun">{</span></li><li class="L2"><span class="pln">    show_404</span><span class="pun">(</span><span class="str">"{$class}/{$method}"</span><span class="pun">);</span></li><li class="L3"><span class="pln">   </span><span class="pun">}</span></li><li class="L4"><span class="pln">  </span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span></li><li class="L7"><span class="pln">  </span><span class="com">//终于调用了！！！！！！！！！！！！！！！！！！！！！！！！！！！就在这里。</span></li><li class="L8"><span class="pln">   </span><span class="com">//不过，不是打击你，虽然我们请求的控制器的那个方法被调用了，但是实际上，我们想要的输出并没有完全输出来。</span></li><li class="L9"><span class="pln">   </span><span class="com">//这就是因为$this-&gt;load-&gt;view();并不是马上输出结果，而是把结果放到缓冲区，然后最后Output类把它冲出来。</span></li><li class="L0"><span class="pln">  call_user_func_array</span><span class="pun">(</span><span class="pln">array</span><span class="pun">(&amp;</span><span class="pln">$CI</span><span class="pun">,</span><span class="pln"> $method</span><span class="pun">),</span><span class="pln"> array_slice</span><span class="pun">(</span><span class="pln">$URI</span><span class="pun">-&gt;</span><span class="pln">rsegments</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">));</span></li><li class="L1"><span class="pln"> </span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln"> </span><span class="com">// Mark a benchmark end point</span></li><li class="L5"><span class="pln"> $BM</span><span class="pun">-&gt;</span><span class="pln">mark</span><span class="pun">(</span><span class="str">'controller_execution_time_( '</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">.</span><span class="str">' / '</span><span class="pun">.</span><span class="pln">$method</span><span class="pun">.</span><span class="str">' )_end'</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">/*</span></li><li class="L8"><span class="com"> * ------------------------------------------------------</span></li><li class="L9"><span class="com"> *  Is there a "post_controller" hook?</span></li><li class="L0"><span class="com"> * ------------------------------------------------------</span></li><li class="L1"><span class="com"> */</span></li><li class="L2"><span class="pln"> $EXT</span><span class="pun">-&gt;</span><span class="pln">_call_hook</span><span class="pun">(</span><span class="str">'post_controller'</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/*</span></li><li class="L5"><span class="com"> * ------------------------------------------------------</span></li><li class="L6"><span class="com"> *  Send the final rendered output to the browser</span></li><li class="L7"><span class="com"> * ------------------------------------------------------</span></li><li class="L8"><span class="com"> */</span></li><li class="L9"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$EXT</span><span class="pun">-&gt;</span><span class="pln">_call_hook</span><span class="pun">(</span><span class="str">'display_override'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">===</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L0"><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">  $OUT</span><span class="pun">-&gt;</span><span class="pln">_display</span><span class="pun">();</span><span class="com">//这里，把$this-&gt;load-&gt;view();里面缓冲的输出结果输出，基本上一个流程总算完成了。详见core/Output.php。</span></li><li class="L2"><span class="pln"> </span><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/*</span></li><li class="L5"><span class="com"> * ------------------------------------------------------</span></li><li class="L6"><span class="com"> *  Is there a "post_system" hook?</span></li><li class="L7"><span class="com"> * ------------------------------------------------------</span></li><li class="L8"><span class="com"> */</span></li><li class="L9"><span class="pln"> $EXT</span><span class="pun">-&gt;</span><span class="pln">_call_hook</span><span class="pun">(</span><span class="str">'post_system'</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">/*</span></li><li class="L2"><span class="com"> * ------------------------------------------------------</span></li><li class="L3"><span class="com"> *  Close the DB connection if one exists</span></li><li class="L4"><span class="com"> * ------------------------------------------------------</span></li><li class="L5"><span class="com"> */</span></li><li class="L6"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">class_exists</span><span class="pun">(</span><span class="str">'CI_DB'</span><span class="pun">)</span><span class="pln"> AND isset</span><span class="pun">(</span><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">db</span><span class="pun">))</span></li><li class="L7"><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">  $CI</span><span class="pun">-&gt;</span><span class="pln">db</span><span class="pun">-&gt;</span><span class="pln">close</span><span class="pun">();</span><span class="com">//关闭连接。</span></li><li class="L9"><span class="pln"> </span><span class="pun">}</span></li></ol></pre>
<p>转载请注明：<a href="http://calixwu.com/" data-original-title="" title="">Calix</a> » <a href="./CodeIgniter源码分析之CodeIgniter.php – Calix的博客_files/CodeIgniter源码分析之CodeIgniter.php – Calix的博客.html" data-original-title="" title="">CodeIgniter源码分析之CodeIgniter.php</a></p>

      
<div class="article-social">
			<a href="javascript:;" data-action="ding" data-id="37" id="Addlike" class="action" data-original-title="" title=""><i class="fa fa-heart-o"></i>喜欢 (<span class="count">13</span>)</a><span class="or">or</span><span class="action action-share bdsharebuttonbox bdshare-button-style0-24" data-bd-bind="1467156958667"><i class="fa fa-share-alt"></i>分享 (<span class="bds_count" data-cmd="count" title="累计分享9次">9</span>)<div class="action-popover"><div class="popover top in"><div class="arrow"></div><div class="popover-content"><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-codeigniter-php.html#" class="sinaweibo fa fa-weibo" data-cmd="tsina" title="" data-original-title="分享到新浪微博"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-codeigniter-php.html#" class="bds_qzone fa fa-star" data-cmd="qzone" title="" data-original-title="分享到QQ空间"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-codeigniter-php.html#" class="tencentweibo fa fa-tencent-weibo" data-cmd="tqq" title="" data-original-title="分享到腾讯微博"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-codeigniter-php.html#" class="qq fa fa-qq" data-cmd="sqq" title="" data-original-title="分享到QQ好友"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-codeigniter-php.html#" class="bds_renren fa fa-renren" data-cmd="renren" title="" data-original-title="分享到人人网"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-codeigniter-php.html#" class="bds_weixin fa fa-weixin" data-cmd="weixin" title="" data-original-title="分享到微信"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-codeigniter-php.html#" class="bds_more fa fa-ellipsis-h" data-cmd="more" data-original-title="" title=""></a></div></div></div></span>	
</div>
	</article>	
				<footer class="article-footer">
			<div class="article-tags"><i class="fa fa-tags"></i><a href="http://calixwu.com/tag/codeigniter" rel="tag" data-original-title="" title="">CodeIgniter</a><a href="http://calixwu.com/tag/mvc" rel="tag" data-original-title="" title="">MVC</a><a href="http://calixwu.com/tag/%e6%a1%86%e6%9e%b6" rel="tag" data-original-title="" title="">框架</a><a href="http://calixwu.com/tag/%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" rel="tag" data-original-title="" title="">源码分析</a></div></footer>
	<nav class="article-nav">
			<span class="article-nav-prev"><i class="fa fa-angle-double-left"></i> <a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-common-php.html" rel="prev">CodeIgniter源码分析之Common.php</a></span>
			<span class="article-nav-next"><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-index-php.html" rel="next">CodeIgniter源码分析之index.php</a>  <i class="fa fa-angle-double-right"></i></span>
		</nav>

		<div class="related_top">
			<div class="related_posts">

<div class="relates">
<ul>
<li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi.html">Memcached源码分析</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-from-set.html">Memcached源码分析之从SET命令开始说起</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-xianchengmoxing.html">Memcached源码分析之线程模型</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-qingqiuchuli-zhuangtaiji.html">Memcached源码分析之请求处理（状态机）</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-neicunguanli.html">Memcached源码分析之内存管理</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-memcached-h.html">Memcached源码分析之memcached.h</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-memcached-c.html">Memcached源码分析之memcached.c</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-thread-c.html">Memcached源码分析之thread.c</a></li>
</ul></div></div>		</div>
						<div id="respond" class="no_webshot">
		<form action="http://calixwu.com/wp-comments-post.php" method="post" id="commentform">
		
		<div class="comt-title">
			<div class="comt-avatar pull-left">
				<img src="./CodeIgniter源码分析之CodeIgniter.php – Calix的博客_files/m32.gif" class="avatar avatar-0" height="54px" width="54px">			</div>
			<div class="comt-author pull-left">
			发表我的评论			</div>
			<a id="cancel-comment-reply-link" class="pull-right" href="javascript:;">取消评论</a>
		</div>
		
		<div class="comt">
			<div class="comt-box">
				<textarea placeholder="写点什么..." class="input-block-level comt-area" name="comment" id="comment" cols="100%" rows="3" tabindex="1" onkeydown="if(event.ctrlKey&amp;&amp;event.keyCode==13){document.getElementById(&#39;submit&#39;).click();return false};"></textarea>
				<div class="comt-ctrl">
					<button class="btn btn-primary pull-right" type="submit" name="submit" id="submit" tabindex="5"><i class="fa fa-check-square-o"></i> 提交评论</button>
					<div class="comt-tips pull-right"><input type="hidden" name="comment_post_ID" value="37" id="comment_post_ID">
<input type="hidden" name="comment_parent" id="comment_parent" value="0">
<div class="comt-tip comt-loading" style="display: none;">正在提交, 请稍候...</div><div class="comt-tip comt-error" style="display: none;">#</div></div>
					<span data-type="comment-insert-smilie" class="muted comt-smilie"><i class="fa fa-smile-o"></i> 表情</span>
					<span class="muted comt-mailme"><label for="comment_mail_notify" class="checkbox inline" style="padding-top:0"><input type="checkbox" name="comment_mail_notify" id="comment_mail_notify" value="comment_mail_notify" checked="checked">有人回复时邮件通知我</label></span>
				</div>
			</div>

												<div class="comt-comterinfo" id="comment-author-info">
						<h4>亲~ 写下昵称哦~</h4>
						<ul>
							<li class="form-inline"><label class="hide" for="author">昵称</label><input class="ipt" type="text" name="author" id="author" value="" tabindex="2" placeholder="昵称"><span class="help-inline">昵称 (必填)</span></li>
						<!--	<li class="form-inline"><label class="hide" for="email">邮箱</label><input class="ipt" type="text" name="email" id="email" value="" tabindex="3" placeholder="邮箱"><span class="help-inline">邮箱 (必填)</span></li> -->
							<li class="form-inline"><label class="hide" for="url">网址</label><input class="ipt" type="text" name="url" id="url" value="" tabindex="4" placeholder="网址"><span class="help-inline">网址</span></li> 
						</ul>
					</div>
									</div>

		
	</form>
	</div>
<div id="postcomments">
	<div id="comments">
		<i class="fa fa-comments-o"></i> <b> (2)</b>个小伙伴在吐槽
	</div>
	<ol class="commentlist">
			</ol>
	<div class="commentnav">
			</div>
</div>
			</div>
</div>
<aside class="sidebar">	
<div class="widget widget_text"><div class="textwidget"><div class="social">
<a href="http://calixwu.com/feed" rel="external nofollow" target="_blank" title="" data-original-title="订阅本站"><i class="rss fa fa-rss"></i></a></div></div></div>

		<div class="widget widget_recent_entries">		<div class="title"><h2>近期文章</h2></div>		<ul>
					<li>
				<a href="http://calixwu.com/2014/11/memcached-yuanmafenxi.html">Memcached源码分析</a>
						</li>
					<li>
				<a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-from-set.html">Memcached源码分析之从SET命令开始说起</a>
						</li>
					<li>
				<a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-xianchengmoxing.html">Memcached源码分析之线程模型</a>
						</li>
					<li>
				<a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-qingqiuchuli-zhuangtaiji.html">Memcached源码分析之请求处理（状态机）</a>
						</li>
					<li>
				<a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-neicunguanli.html">Memcached源码分析之内存管理</a>
						</li>
				</ul>
		</div><div class="widget widget_categories"><div class="title"><h2>分类目录</h2></div>		<ul>
	<li class="cat-item cat-item-4"><a href="http://calixwu.com/category/codeigniter">CodeIgniter</a>
</li>
	<li class="cat-item cat-item-3"><a href="http://calixwu.com/category/memcached">Memcached</a>
</li>
		</ul>
</div></aside>
</section>
<footer class="footer">
    <div class="footer-inner">
        <div class="copyright pull-left">
        	<a href="http://calixwu.com/" title="Calix的博客">Calix的博客</a> 版权所有，保留一切权利 ·   基于<a href="http://cn.wordpress.org/">WordPress</a>构建   © 2014-2015

	</div>
        <div class="trackcode pull-right">
            <script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F77f536717c5f64cbc346960632d9eedb' type='text/javascript'%3E%3C/script%3E"));
</script><script src="./CodeIgniter源码分析之CodeIgniter.php – Calix的博客_files/h.js" type="text/javascript"></script><a href="http://tongji.baidu.com/hm-web/welcome/ico?s=77f536717c5f64cbc346960632d9eedb" target="_blank"><img border="0" src="./CodeIgniter源码分析之CodeIgniter.php – Calix的博客_files/21.gif" width="20" height="20"></a>

<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1254487188'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1254487188' type='text/javascript'%3E%3C/script%3E"));</script><span id="cnzz_stat_icon_1254487188"><a href="http://www.cnzz.com/stat/website.php?web_id=1254487188" target="_blank" title="站长统计">站长统计</a></span><script src="./CodeIgniter源码分析之CodeIgniter.php – Calix的博客_files/z_stat.php" type="text/javascript"></script><script src="./CodeIgniter源码分析之CodeIgniter.php – Calix的博客_files/core.php" charset="utf-8" type="text/javascript"></script>        </div>
    </div>
</footer>

<script>with(document)0[(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion="+~(-new Date()/36e5)];</script>

<div class="rollto"><button class="btn btn-inverse" data-type="totop" title="回顶部"><i class="fa fa-arrow-up"></i></button><button class="btn btn-inverse" data-type="torespond" title="发评论"><i class="fa fa-comment-o"></i></button></div></body></html>