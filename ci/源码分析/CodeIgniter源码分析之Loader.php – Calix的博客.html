<!DOCTYPE html>
<!-- saved from url=(0062)http://calixwu.com/2014/11/codeigniter-yuanmafenxi-loader.html -->
<html><style type="text/css" id="89114702144"></style><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=10,IE=9,IE=8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
<title>CodeIgniter源码分析之Loader.php – Calix的博客</title>
<script>
window._deel = {name: 'Calix',url: 'http://calixwu.com/wp-content/themes/yusi1.0', ajaxpager: '', commenton: 1, roll: [0,0]}
</script>
<meta name="author" content="calix,吴国清,calixwu">
<link rel="stylesheet" id="style-css" href="./CodeIgniter源码分析之Loader.php – Calix的博客_files/style.css" type="text/css" media="all">
<script type="text/javascript" src="./CodeIgniter源码分析之Loader.php – Calix的博客_files/jquery.min.js"></script>
<script type="text/javascript" src="./CodeIgniter源码分析之Loader.php – Calix的博客_files/jquery.js"></script>
<link rel="next" title="CodeIgniter源码分析之Model.php" href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-model-php.html">
<link rel="canonical" href="./CodeIgniter源码分析之Loader.php – Calix的博客_files/CodeIgniter源码分析之Loader.php – Calix的博客.html">
<link rel="shortlink" href="http://calixwu.com/?p=10">
<meta name="keywords" content="CodeIgniter, loader, MVC, 加载器, 框架, 源码分析, CodeIgniter">
<meta name="description" content="作者：Calix &lt;?php if ( ! defined(&#39;BASEPATH&#39;)) exit(&#39;No direct script access allowed&#39;); /** * Loader Class * * Loader组件在CI里面也是一个很重要的组件，功能也比较明了。 * 如果已经阅读过Controller组件，会发现Controller组件的代码也只有十来行，但它却可以做很多事，一定程度上 * 要归功于Loader组件">
<style type="text/css" id="syntaxhighlighteranchor"></style>
<!--[if lt IE 9]><script src="http://calixwu.com/wp-content/themes/yusi1.0/js/html5.js"></script><![endif]-->
<script src="./CodeIgniter源码分析之Loader.php – Calix的博客_files/share.js"></script><link href="./CodeIgniter源码分析之Loader.php – Calix的博客_files/share.css" rel="styleSheet" type="text/css"></head>
<body class="single single-post postid-10 single-format-standard">

<header id="header" class="header">
<div class="container-inner">
 <div class="yusi-logo">
                    <a href="http://calixwu.com/">
                        <h1>
                                                        <span class="yusi-mono">Calix</span>
                                                        <span class="yusi-bloger">善于总结。</span>
                                                    </h1>
                    </a>
    </div>
</div>

	<div id="nav-header" class="navbar">
		
		<ul class="nav">
			<li id="menu-item-4" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-4"><a href="http://calixwu.com/">首页</a></li>
<li style="float:right;">
                    <div class="toggle-search"><i class="fa fa-search"></i></div>
<div class="search-expand" style="display: none;"><div class="search-expand-inner"><form method="get" class="searchform themeform" onsubmit="location.href=&#39;http://calixwu.com/search/&#39; + encodeURIComponent(this.s.value).replace(/%20/g, &#39;+&#39;); return false;" action="http://calixwu.com/"><div> <input type="ext" class="search" name="s" onblur="if(this.value==&#39;&#39;)this.value=&#39;search...&#39;;" onfocus="if(this.value==&#39;search...&#39;)this.value=&#39;&#39;;" value="search..."></div></form></div></div>
</li>
		</ul><div class="screen-mini"><button data-type="screen-nav" class="btn btn-inverse screen-nav"><i class="fa fa-list"></i></button></div>
	</div>
</header>
<section class="container"><div class="speedbar">
				<div class="toptip"><strong class="text-success"><i class="fa fa-volume-up"></i> </strong> </div>
	</div>
	<div class="content-wrap">
	<div class="content">

				<header class="article-header">
			<h1 class="article-title"><a href="./CodeIgniter源码分析之Loader.php – Calix的博客_files/CodeIgniter源码分析之Loader.php – Calix的博客.html">CodeIgniter源码分析之Loader.php</a></h1>
			<div class="meta">
				<span id="mute-category" class="muted"><i class="fa fa-list-alt"></i><a href="http://calixwu.com/category/codeigniter"> CodeIgniter</a></span>				<!--
				<span class="muted"><i class="fa fa-user"></i> <a href="http://calixwu.com/author/calix">calix</a></span>-->
				<time class="muted"><i class="fa fa-clock-o"></i> 2年前 (2014-11-19)</time>
				<span class="muted" style="color:#dd6666"><i class="fa fa-eye"></i> 880℃</span>
											</div>
		</header>
		<article class="article-content">
			<p>作者：<a href="http://calixwu.com/" data-original-title="" title="">Calix</a></p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="pun">&lt;?</span><span class="pln">php </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> </span><span class="kwd">defined</span><span class="pun">(</span><span class="str">'BASEPATH'</span><span class="pun">))</span><span class="pln"> </span><span class="kwd">exit</span><span class="pun">(</span><span class="str">'No direct script access allowed'</span><span class="pun">);</span></li><li class="L1"><span class="com">/**</span></li><li class="L2"><span class="com">* Loader Class</span></li><li class="L3"><span class="com">*</span></li><li class="L4"><span class="com">* Loader组件在CI里面也是一个很重要的组件，功能也比较明了。</span></li><li class="L5"><span class="com">* 如果已经阅读过Controller组件，会发现Controller组件的代码也只有十来行，但它却可以做很多事，一定程度上</span></li><li class="L6"><span class="com">* 要归功于Loader组件这个好助手或者好基友。</span></li><li class="L7"><span class="com">* 不过Loader组件的代码真的不少，主要以常用的几个方法以主线来探讨：model(),view(),library(),helper();</span></li><li class="L8"><span class="com">*/</span></li><li class="L9"><span class="kwd">class</span><span class="pln"> CI_Loader </span><span class="pun">{</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">// All these are set automatically. Don't mess with them.</span></li><li class="L2"><span class="com">/**</span></li><li class="L3"><span class="com">* Nesting level of the output buffering mechanism</span></li><li class="L4"><span class="com">*/</span></li><li class="L5"><span class="kwd">protected</span><span class="pln"> $_ci_ob_level</span><span class="pun">;</span></li><li class="L6"><span class="com">/**</span></li><li class="L7"><span class="com">* List of paths to load views from</span></li><li class="L8"><span class="com">*/</span></li><li class="L9"><span class="kwd">protected</span><span class="pln"> $_ci_view_paths </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span></li><li class="L0"><span class="com">/**</span></li><li class="L1"><span class="com">* List of paths to load libraries from</span></li><li class="L2"><span class="com">*/</span></li><li class="L3"><span class="kwd">protected</span><span class="pln"> $_ci_library_paths </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span></li><li class="L4"><span class="com">/**</span></li><li class="L5"><span class="com">* List of paths to load models from</span></li><li class="L6"><span class="com">*/</span></li><li class="L7"><span class="kwd">protected</span><span class="pln"> $_ci_model_paths </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span></li><li class="L8"><span class="com">/**</span></li><li class="L9"><span class="com">* List of paths to load helpers from</span></li><li class="L0"><span class="com">*/</span></li><li class="L1"><span class="kwd">protected</span><span class="pln"> $_ci_helper_paths </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span></li><li class="L2"><span class="com">/**</span></li><li class="L3"><span class="com">* List of loaded base classes</span></li><li class="L4"><span class="com">*/</span></li><li class="L5"><span class="kwd">protected</span><span class="pln"> $_base_classes </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span><span class="pln"> </span><span class="com">// Set by the controller class</span></li><li class="L6"><span class="com">/**</span></li><li class="L7"><span class="com">* List of cached variables</span></li><li class="L8"><span class="com">*/</span></li><li class="L9"><span class="kwd">protected</span><span class="pln"> $_ci_cached_vars </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span></li><li class="L0"><span class="com">/**</span></li><li class="L1"><span class="com">* List of loaded classes</span></li><li class="L2"><span class="com">*/</span></li><li class="L3"><span class="kwd">protected</span><span class="pln"> $_ci_classes </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span></li><li class="L4"><span class="com">/**</span></li><li class="L5"><span class="com">* List of loaded files</span></li><li class="L6"><span class="com">*/</span></li><li class="L7"><span class="kwd">protected</span><span class="pln"> $_ci_loaded_files </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span></li><li class="L8"><span class="com">/**</span></li><li class="L9"><span class="com">* List of loaded models</span></li><li class="L0"><span class="com">*/</span></li><li class="L1"><span class="kwd">protected</span><span class="pln"> $_ci_models </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span></li><li class="L2"><span class="com">/**</span></li><li class="L3"><span class="com">* List of loaded helpers</span></li><li class="L4"><span class="com">*/</span></li><li class="L5"><span class="kwd">protected</span><span class="pln"> $_ci_helpers </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span></li><li class="L6"><span class="com">/**</span></li><li class="L7"><span class="com">* List of class name mappings</span></li><li class="L8"><span class="com">*/</span></li><li class="L9"><span class="kwd">protected</span><span class="pln"> $_ci_varmap </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">(</span><span class="str">'unit_test'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'unit'</span><span class="pun">,</span></li><li class="L0"><span class="str">'user_agent'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'agent'</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">/**</span></li><li class="L3"><span class="com">* Constructor</span></li><li class="L4"><span class="com">*/</span></li><li class="L5"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> __construct</span><span class="pun">()</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_ob_level </span><span class="pun">=</span><span class="pln"> ob_get_level</span><span class="pun">();</span></li><li class="L8"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_library_paths </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">,</span><span class="pln"> BASEPATH</span><span class="pun">);</span></li><li class="L9"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_helper_paths </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">,</span><span class="pln"> BASEPATH</span><span class="pun">);</span></li><li class="L0"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_model_paths </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">);</span></li><li class="L1"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_view_paths </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">.</span><span class="str">'views/'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> TRUE</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">log_message</span><span class="pun">(</span><span class="str">'debug'</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Loader Class Initialized"</span><span class="pun">);</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// --------------------------------------------------------------------</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/**</span></li><li class="L9"><span class="com">* Initialize the Loader</span></li><li class="L0"><span class="com">*/</span></li><li class="L1"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> initialize</span><span class="pun">()</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_classes </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span></li><li class="L4"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_loaded_files </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span></li><li class="L5"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_models </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">//这个is_loaded方法就是在core/Common.php中定义的全局函数，在Loader组件还没有加载之前，由它来负责记录</span></li><li class="L8"><span class="com">//哪些核心类已经加载过，现在Loader组件要加载了，就把信息交给Loader组件，保存在Loader::$_base_classes中。</span></li><li class="L9"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_base_classes </span><span class="pun">=&amp;</span><span class="pln"> is_loaded</span><span class="pun">();</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">//自动加载，加载项是你在config/autoload.php中设置的。</span></li><li class="L2"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_autoloader</span><span class="pun">();</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">;</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">// --------------------------------------------------------------------</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">/**</span></li><li class="L0"><span class="com">* Is Loaded</span></li><li class="L1"><span class="com">*/</span></li><li class="L2"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> is_loaded</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">)</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_classes</span><span class="pun">[</span><span class="pln">$class</span><span class="pun">]))</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_classes</span><span class="pun">[</span><span class="pln">$class</span><span class="pun">];</span></li><li class="L7"><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="kwd">return</span><span class="pln"> FALSE</span><span class="pun">;</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">// --------------------------------------------------------------------</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/**</span></li><li class="L5"><span class="com">* Class Loader</span></li><li class="L6"><span class="com">* $library为相应的类名，$params为实例化此类的时候可能要用到的参数，$object_name为给这个类的实例自义定一个名字。</span></li><li class="L7"><span class="com">*/</span></li><li class="L8"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> library</span><span class="pun">(</span><span class="pln">$library </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> $params </span><span class="pun">=</span><span class="pln"> NULL</span><span class="pun">,</span><span class="pln"> $object_name </span><span class="pun">=</span><span class="pln"> NULL</span><span class="pun">)</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="com">//如果是通过数组加载多个，把它拆开再调用本方法，其实它可以递归调用多维数组，不过没有这个必要。</span></li><li class="L1"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">is_array</span><span class="pun">(</span><span class="pln">$library</span><span class="pun">))</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$library </span><span class="kwd">as</span><span class="pln"> $class</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">library</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">,</span><span class="pln"> $params</span><span class="pun">);</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="kwd">return</span><span class="pun">;</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">//接下来两个if都是关于合法性的判断。</span></li><li class="L2"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$library </span><span class="pun">==</span><span class="pln"> </span><span class="str">''</span><span class="pln"> OR isset</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_base_classes</span><span class="pun">[</span><span class="pln">$library</span><span class="pun">]))</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="kwd">return</span><span class="pln"> FALSE</span><span class="pun">;</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> is_null</span><span class="pun">(</span><span class="pln">$params</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> is_array</span><span class="pun">(</span><span class="pln">$params</span><span class="pun">))</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln">$params </span><span class="pun">=</span><span class="pln"> NULL</span><span class="pun">;</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">//真正把类加载进来的是下面这个方法。</span></li><li class="L3"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_load_class</span><span class="pun">(</span><span class="pln">$library</span><span class="pun">,</span><span class="pln"> $params</span><span class="pun">,</span><span class="pln"> $object_name</span><span class="pun">);</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// --------------------------------------------------------------------</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/**</span></li><li class="L9"><span class="com">* Model Loader</span></li><li class="L0"><span class="com">*/</span></li><li class="L1"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> model</span><span class="pun">(</span><span class="pln">$model</span><span class="pun">,</span><span class="pln"> $name </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> $db_conn </span><span class="pun">=</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="com">//可以以数组形式同时加载多个$model</span></li><li class="L4"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">is_array</span><span class="pun">(</span><span class="pln">$model</span><span class="pun">))</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$model </span><span class="kwd">as</span><span class="pln"> $babe</span><span class="pun">)</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">model</span><span class="pun">(</span><span class="pln">$babe</span><span class="pun">);</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="kwd">return</span><span class="pun">;</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$model </span><span class="pun">==</span><span class="pln"> </span><span class="str">''</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="kwd">return</span><span class="pun">;</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">$path </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">;</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">//判断是否包含目录信息</span></li><li class="L1"><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">$last_slash </span><span class="pun">=</span><span class="pln"> strrpos</span><span class="pun">(</span><span class="pln">$model</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/'</span><span class="pun">))</span><span class="pln"> </span><span class="pun">!==</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">$path </span><span class="pun">=</span><span class="pln"> substr</span><span class="pun">(</span><span class="pln">$model</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> $last_slash </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">$model </span><span class="pun">=</span><span class="pln"> substr</span><span class="pun">(</span><span class="pln">$model</span><span class="pun">,</span><span class="pln"> $last_slash </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">//如果没有给当前model定义名字，则以$model本身作为名字。</span></li><li class="L9"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$name </span><span class="pun">==</span><span class="pln"> </span><span class="str">''</span><span class="pun">)</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">$name </span><span class="pun">=</span><span class="pln"> $model</span><span class="pun">;</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">//如果已经加载过此model，直接退出本函数。</span></li><li class="L5"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">in_array</span><span class="pun">(</span><span class="pln">$name</span><span class="pun">,</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_models</span><span class="pun">,</span><span class="pln"> TRUE</span><span class="pun">))</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="kwd">return</span><span class="pun">;</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">$CI </span><span class="pun">=&amp;</span><span class="pln"> get_instance</span><span class="pun">();</span></li><li class="L1"><span class="com">//如果加载的model名字与之前加载过的类有冲突，则报错。</span></li><li class="L2"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">$name</span><span class="pun">))</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">show_error</span><span class="pun">(</span><span class="str">'The model name you are loading is the name of a resource that is already being used: '</span><span class="pun">.</span><span class="pln">$name</span><span class="pun">);</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">//model文件必段是全小写。</span></li><li class="L8"><span class="pln">$model </span><span class="pun">=</span><span class="pln"> strtolower</span><span class="pun">(</span><span class="pln">$model</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_model_paths </span><span class="kwd">as</span><span class="pln"> $mod_path</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> file_exists</span><span class="pun">(</span><span class="pln">$mod_path</span><span class="pun">.</span><span class="str">'models/'</span><span class="pun">.</span><span class="pln">$path</span><span class="pun">.</span><span class="pln">$model</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">))</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="kwd">continue</span><span class="pun">;</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">//如果要求同时连接数据库。则调用Loader::database()方法加载数据库类。</span></li><li class="L8"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$db_conn </span><span class="pun">!==</span><span class="pln"> FALSE AND </span><span class="pun">!</span><span class="pln"> class_exists</span><span class="pun">(</span><span class="str">'CI_DB'</span><span class="pun">))</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$db_conn </span><span class="pun">===</span><span class="pln"> TRUE</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">$db_conn </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">;</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">load</span><span class="pun">-&gt;</span><span class="pln">database</span><span class="pun">(</span><span class="pln">$db_conn</span><span class="pun">,</span><span class="pln"> FALSE</span><span class="pun">,</span><span class="pln"> TRUE</span><span class="pun">);</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">//加载父类model。</span></li><li class="L9"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> class_exists</span><span class="pun">(</span><span class="str">'CI_Model'</span><span class="pun">))</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">load_class</span><span class="pun">(</span><span class="str">'Model'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'core'</span><span class="pun">);</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">//引入当前model</span></li><li class="L5"><span class="pln">require_once</span><span class="pun">(</span><span class="pln">$mod_path</span><span class="pun">.</span><span class="str">'models/'</span><span class="pun">.</span><span class="pln">$path</span><span class="pun">.</span><span class="pln">$model</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">//把文件名的第一个字母大写作为类名，规定的命名规范。</span></li><li class="L8"><span class="pln">$model </span><span class="pun">=</span><span class="pln"> ucfirst</span><span class="pun">(</span><span class="pln">$model</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">$name </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> $model</span><span class="pun">();</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">//保存在Loader::_ci_models中，以后可以用它来判断某个model是否已经加载过。</span></li><li class="L3"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_models</span><span class="pun">[]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> $name</span><span class="pun">;</span></li><li class="L4"><span class="kwd">return</span><span class="pun">;</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">show_error</span><span class="pun">(</span><span class="str">'Unable to locate the model you have specified: '</span><span class="pun">.</span><span class="pln">$model</span><span class="pun">);</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">// --------------------------------------------------------------------</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">/**</span></li><li class="L3"><span class="com">* Database Loader</span></li><li class="L4"><span class="com">*/</span></li><li class="L5"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> database</span><span class="pun">(</span><span class="pln">$params </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> $return </span><span class="pun">=</span><span class="pln"> FALSE</span><span class="pun">,</span><span class="pln"> $active_record </span><span class="pun">=</span><span class="pln"> NULL</span><span class="pun">)</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">$CI </span><span class="pun">=&amp;</span><span class="pln"> get_instance</span><span class="pun">();</span></li><li class="L8"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">class_exists</span><span class="pun">(</span><span class="str">'CI_DB'</span><span class="pun">)</span><span class="pln"> AND $return </span><span class="pun">==</span><span class="pln"> FALSE AND $active_record </span><span class="pun">==</span><span class="pln"> NULL AND isset</span><span class="pun">(</span><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">db</span><span class="pun">)</span><span class="pln"> AND is_object</span><span class="pun">(</span><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">db</span><span class="pun">))</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="kwd">return</span><span class="pln"> FALSE</span><span class="pun">;</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">require_once</span><span class="pun">(</span><span class="pln">BASEPATH</span><span class="pun">.</span><span class="str">'database/DB.php'</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$return </span><span class="pun">===</span><span class="pln"> TRUE</span><span class="pun">)</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="kwd">return</span><span class="pln"> DB</span><span class="pun">(</span><span class="pln">$params</span><span class="pun">,</span><span class="pln"> $active_record</span><span class="pun">);</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">db </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">;</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">db </span><span class="pun">=&amp;</span><span class="pln"> DB</span><span class="pun">(</span><span class="pln">$params</span><span class="pun">,</span><span class="pln"> $active_record</span><span class="pun">);</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">// --------------------------------------------------------------------</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">/**</span></li><li class="L7"><span class="com">* Load the Utilities Class</span></li><li class="L8"><span class="com">*/</span></li><li class="L9"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> dbutil</span><span class="pun">()</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> class_exists</span><span class="pun">(</span><span class="str">'CI_DB'</span><span class="pun">))</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">database</span><span class="pun">();</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">$CI </span><span class="pun">=&amp;</span><span class="pln"> get_instance</span><span class="pun">();</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">// for backwards compatibility, load dbforge so we can extend dbutils off it</span></li><li class="L9"><span class="com">// this use is deprecated and strongly discouraged</span></li><li class="L0"><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">load</span><span class="pun">-&gt;</span><span class="pln">dbforge</span><span class="pun">();</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">require_once</span><span class="pun">(</span><span class="pln">BASEPATH</span><span class="pun">.</span><span class="str">'database/DB_utility.php'</span><span class="pun">);</span></li><li class="L3"><span class="pln">require_once</span><span class="pun">(</span><span class="pln">BASEPATH</span><span class="pun">.</span><span class="str">'database/drivers/'</span><span class="pun">.</span><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">db</span><span class="pun">-&gt;</span><span class="pln">dbdriver</span><span class="pun">.</span><span class="str">'/'</span><span class="pun">.</span><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">db</span><span class="pun">-&gt;</span><span class="pln">dbdriver</span><span class="pun">.</span><span class="str">'_utility.php'</span><span class="pun">);</span></li><li class="L4"><span class="pln">$class </span><span class="pun">=</span><span class="pln"> </span><span class="str">'CI_DB_'</span><span class="pun">.</span><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">db</span><span class="pun">-&gt;</span><span class="pln">dbdriver</span><span class="pun">.</span><span class="str">'_utility'</span><span class="pun">;</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">dbutil </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> $class</span><span class="pun">();</span></li><li class="L7"><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">// --------------------------------------------------------------------</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">/**</span></li><li class="L2"><span class="com">* Load the Database Forge Class</span></li><li class="L3"><span class="com">*/</span></li><li class="L4"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> dbforge</span><span class="pun">()</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> class_exists</span><span class="pun">(</span><span class="str">'CI_DB'</span><span class="pun">))</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">database</span><span class="pun">();</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">$CI </span><span class="pun">=&amp;</span><span class="pln"> get_instance</span><span class="pun">();</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">require_once</span><span class="pun">(</span><span class="pln">BASEPATH</span><span class="pun">.</span><span class="str">'database/DB_forge.php'</span><span class="pun">);</span></li><li class="L4"><span class="pln">require_once</span><span class="pun">(</span><span class="pln">BASEPATH</span><span class="pun">.</span><span class="str">'database/drivers/'</span><span class="pun">.</span><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">db</span><span class="pun">-&gt;</span><span class="pln">dbdriver</span><span class="pun">.</span><span class="str">'/'</span><span class="pun">.</span><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">db</span><span class="pun">-&gt;</span><span class="pln">dbdriver</span><span class="pun">.</span><span class="str">'_forge.php'</span><span class="pun">);</span></li><li class="L5"><span class="pln">$class </span><span class="pun">=</span><span class="pln"> </span><span class="str">'CI_DB_'</span><span class="pun">.</span><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">db</span><span class="pun">-&gt;</span><span class="pln">dbdriver</span><span class="pun">.</span><span class="str">'_forge'</span><span class="pun">;</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">dbforge </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> $class</span><span class="pun">();</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">// --------------------------------------------------------------------</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">/**</span></li><li class="L3"><span class="com">* Load View</span></li><li class="L4"><span class="com">*</span></li><li class="L5"><span class="com">* Loader::view();方法可以和Loader::file()方法一并来阅读，实质上它们都是调用了Loader::_ci_load();方法。</span></li><li class="L6"><span class="com">*/</span></li><li class="L7"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> view</span><span class="pun">(</span><span class="pln">$view</span><span class="pun">,</span><span class="pln"> $vars </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">(),</span><span class="pln"> $return </span><span class="pun">=</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_load</span><span class="pun">(</span><span class="pln">array</span><span class="pun">(</span><span class="str">'_ci_view'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $view</span><span class="pun">,</span><span class="pln"> </span><span class="str">'_ci_vars'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_object_to_array</span><span class="pun">(</span><span class="pln">$vars</span><span class="pun">),</span><span class="pln"> </span><span class="str">'_ci_return'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $return</span><span class="pun">));</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">// --------------------------------------------------------------------</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/**</span></li><li class="L5"><span class="com">* Load File</span></li><li class="L6"><span class="com">*/</span></li><li class="L7"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> file</span><span class="pun">(</span><span class="pln">$path</span><span class="pun">,</span><span class="pln"> $return </span><span class="pun">=</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_load</span><span class="pun">(</span><span class="pln">array</span><span class="pun">(</span><span class="str">'_ci_path'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $path</span><span class="pun">,</span><span class="pln"> </span><span class="str">'_ci_return'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $return</span><span class="pun">));</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">// --------------------------------------------------------------------</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/**</span></li><li class="L5"><span class="com">* Set Variables</span></li><li class="L6"><span class="com">*/</span></li><li class="L7"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> vars</span><span class="pun">(</span><span class="pln">$vars </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">(),</span><span class="pln"> $val </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">)</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$val </span><span class="pun">!=</span><span class="pln"> </span><span class="str">''</span><span class="pln"> AND is_string</span><span class="pun">(</span><span class="pln">$vars</span><span class="pun">))</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">$vars </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">(</span><span class="pln">$vars </span><span class="pun">=&gt;</span><span class="pln"> $val</span><span class="pun">);</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">$vars </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_object_to_array</span><span class="pun">(</span><span class="pln">$vars</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">is_array</span><span class="pun">(</span><span class="pln">$vars</span><span class="pun">)</span><span class="pln"> AND count</span><span class="pun">(</span><span class="pln">$vars</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$vars </span><span class="kwd">as</span><span class="pln"> $key </span><span class="pun">=&gt;</span><span class="pln"> $val</span><span class="pun">)</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_cached_vars</span><span class="pun">[</span><span class="pln">$key</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> $val</span><span class="pun">;</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">// --------------------------------------------------------------------</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">/**</span></li><li class="L8"><span class="com">* Get Variable</span></li><li class="L9"><span class="com">*/</span></li><li class="L0"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> get_var</span><span class="pun">(</span><span class="pln">$key</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="kwd">return</span><span class="pln"> isset</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_cached_vars</span><span class="pun">[</span><span class="pln">$key</span><span class="pun">])</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_cached_vars</span><span class="pun">[</span><span class="pln">$key</span><span class="pun">]</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> NULL</span><span class="pun">;</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">// --------------------------------------------------------------------</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">/**</span></li><li class="L8"><span class="com">* Load Helper</span></li><li class="L9"><span class="com">*/</span></li><li class="L0"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> helper</span><span class="pun">(</span><span class="pln">$helpers </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">())</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="com">//Loader::_ci_prep_filename()方法只是处理文件名，以返回正确的数组而已。</span></li><li class="L3"><span class="com">//默认helper的文件名是以_helper为后缀，所以参数可以不用写_helper后缀，当然写也不会出错，因为</span></li><li class="L4"><span class="com">//Loader::_ci_prep_filename()会帮你处理掉。</span></li><li class="L5"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_prep_filename</span><span class="pun">(</span><span class="pln">$helpers</span><span class="pun">,</span><span class="pln"> </span><span class="str">'_helper'</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> $helper</span><span class="pun">)</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="com">//如果已经加载过此helper，则跳过。</span></li><li class="L8"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_helpers</span><span class="pun">[</span><span class="pln">$helper</span><span class="pun">]))</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="kwd">continue</span><span class="pun">;</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">//helper的扩展。并非只有类可以扩展，函数也提供了扩展。注意这里是在APPPATH下。</span></li><li class="L4"><span class="pln">$ext_helper </span><span class="pun">=</span><span class="pln"> APPPATH</span><span class="pun">.</span><span class="str">'helpers/'</span><span class="pun">.</span><span class="pln">config_item</span><span class="pun">(</span><span class="str">'subclass_prefix'</span><span class="pun">).</span><span class="pln">$helper</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">;</span></li><li class="L5"><span class="com">//如果存在对些helper的扩展。</span></li><li class="L6"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">file_exists</span><span class="pun">(</span><span class="pln">$ext_helper</span><span class="pun">))</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="com">//先引入CI自带的helper，再引入我们写的扩展。</span></li><li class="L9"><span class="pln">$base_helper </span><span class="pun">=</span><span class="pln"> BASEPATH</span><span class="pun">.</span><span class="str">'helpers/'</span><span class="pun">.</span><span class="pln">$helper</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">;</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> file_exists</span><span class="pun">(</span><span class="pln">$base_helper</span><span class="pun">))</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">show_error</span><span class="pun">(</span><span class="str">'Unable to load the requested file: helpers/'</span><span class="pun">.</span><span class="pln">$helper</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">);</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">include_once</span><span class="pun">(</span><span class="pln">$ext_helper</span><span class="pun">);</span></li><li class="L7"><span class="pln">include_once</span><span class="pun">(</span><span class="pln">$base_helper</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_helpers</span><span class="pun">[</span><span class="pln">$helper</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> TRUE</span><span class="pun">;</span></li><li class="L0"><span class="pln">log_message</span><span class="pun">(</span><span class="str">'debug'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Helper loaded: '</span><span class="pun">.</span><span class="pln">$helper</span><span class="pun">);</span></li><li class="L1"><span class="kwd">continue</span><span class="pun">;</span><span class="com">//继续下一个helper的引入。</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">//如果没有扩展的话，则分别从APPPATH和BASEPATH，即应用目录和系统目录下找到相应的helper。</span></li><li class="L5"><span class="com">//Loader::_ci_helper_paths默认是APPPATH和BASEPATH两个目录。如果你要再添加新的目录路径，可以</span></li><li class="L6"><span class="com">//通过Loader::add_package_path()方法设置（model,library等同理）</span></li><li class="L7"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_helper_paths </span><span class="kwd">as</span><span class="pln"> $path</span><span class="pun">)</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">file_exists</span><span class="pun">(</span><span class="pln">$path</span><span class="pun">.</span><span class="str">'helpers/'</span><span class="pun">.</span><span class="pln">$helper</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">))</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">include_once</span><span class="pun">(</span><span class="pln">$path</span><span class="pun">.</span><span class="str">'helpers/'</span><span class="pun">.</span><span class="pln">$helper</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_helpers</span><span class="pun">[</span><span class="pln">$helper</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> TRUE</span><span class="pun">;</span></li><li class="L4"><span class="pln">log_message</span><span class="pun">(</span><span class="str">'debug'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Helper loaded: '</span><span class="pun">.</span><span class="pln">$helper</span><span class="pun">);</span></li><li class="L5"><span class="kwd">break</span><span class="pun">;</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> isset</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_helpers</span><span class="pun">[</span><span class="pln">$helper</span><span class="pun">]))</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">show_error</span><span class="pun">(</span><span class="str">'Unable to load the requested file: helpers/'</span><span class="pun">.</span><span class="pln">$helper</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">);</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// --------------------------------------------------------------------</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/**</span></li><li class="L9"><span class="com">* Load Helpers</span></li><li class="L0"><span class="com">*/</span></li><li class="L1"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> helpers</span><span class="pun">(</span><span class="pln">$helpers </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">())</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">helper</span><span class="pun">(</span><span class="pln">$helpers</span><span class="pun">);</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// --------------------------------------------------------------------</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/**</span></li><li class="L9"><span class="com">* Loads a language file</span></li><li class="L0"><span class="com">*/</span></li><li class="L1"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> language</span><span class="pun">(</span><span class="pln">$file </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">(),</span><span class="pln"> $lang </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">$CI </span><span class="pun">=&amp;</span><span class="pln"> get_instance</span><span class="pun">();</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> is_array</span><span class="pun">(</span><span class="pln">$file</span><span class="pun">))</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">$file </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">(</span><span class="pln">$file</span><span class="pun">);</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$file </span><span class="kwd">as</span><span class="pln"> $langfile</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">lang</span><span class="pun">-&gt;</span><span class="pln">load</span><span class="pun">(</span><span class="pln">$langfile</span><span class="pun">,</span><span class="pln"> $lang</span><span class="pun">);</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// --------------------------------------------------------------------</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/**</span></li><li class="L9"><span class="com">* Loads a config file</span></li><li class="L0"><span class="com">*/</span></li><li class="L1"><span class="com">//这里的config方法，实质是完完全全调用Config组件的load方法而已。</span></li><li class="L2"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> config</span><span class="pun">(</span><span class="pln">$file </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> $use_sections </span><span class="pun">=</span><span class="pln"> FALSE</span><span class="pun">,</span><span class="pln"> $fail_gracefully </span><span class="pun">=</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">$CI </span><span class="pun">=&amp;</span><span class="pln"> get_instance</span><span class="pun">();</span></li><li class="L5"><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">config</span><span class="pun">-&gt;</span><span class="pln">load</span><span class="pun">(</span><span class="pln">$file</span><span class="pun">,</span><span class="pln"> $use_sections</span><span class="pun">,</span><span class="pln"> $fail_gracefully</span><span class="pun">);</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">// --------------------------------------------------------------------</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">/**</span></li><li class="L1"><span class="com">* Driver</span></li><li class="L2"><span class="com">*/</span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> driver</span><span class="pun">(</span><span class="pln">$library </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> $params </span><span class="pun">=</span><span class="pln"> NULL</span><span class="pun">,</span><span class="pln"> $object_name </span><span class="pun">=</span><span class="pln"> NULL</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> class_exists</span><span class="pun">(</span><span class="str">'CI_Driver_Library'</span><span class="pun">))</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="kwd">require</span><span class="pln"> BASEPATH</span><span class="pun">.</span><span class="str">'libraries/Driver.php'</span><span class="pun">;</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$library </span><span class="pun">==</span><span class="pln"> </span><span class="str">''</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="kwd">return</span><span class="pln"> FALSE</span><span class="pun">;</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> strpos</span><span class="pun">(</span><span class="pln">$library</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/'</span><span class="pun">))</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">$library </span><span class="pun">=</span><span class="pln"> ucfirst</span><span class="pun">(</span><span class="pln">$library</span><span class="pun">).</span><span class="str">'/'</span><span class="pun">.</span><span class="pln">$library</span><span class="pun">;</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">library</span><span class="pun">(</span><span class="pln">$library</span><span class="pun">,</span><span class="pln"> $params</span><span class="pun">,</span><span class="pln"> $object_name</span><span class="pun">);</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">// --------------------------------------------------------------------</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/**</span></li><li class="L6"><span class="com">* Add Package Path</span></li><li class="L7"><span class="com">*/</span></li><li class="L8"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> add_package_path</span><span class="pun">(</span><span class="pln">$path</span><span class="pun">,</span><span class="pln"> $view_cascade</span><span class="pun">=</span><span class="pln">TRUE</span><span class="pun">)</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln">$path </span><span class="pun">=</span><span class="pln"> rtrim</span><span class="pun">(</span><span class="pln">$path</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/'</span><span class="pun">).</span><span class="str">'/'</span><span class="pun">;</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">array_unshift</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_library_paths</span><span class="pun">,</span><span class="pln"> $path</span><span class="pun">);</span></li><li class="L3"><span class="pln">array_unshift</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_model_paths</span><span class="pun">,</span><span class="pln"> $path</span><span class="pun">);</span></li><li class="L4"><span class="pln">array_unshift</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_helper_paths</span><span class="pun">,</span><span class="pln"> $path</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_view_paths </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">(</span><span class="pln">$path</span><span class="pun">.</span><span class="str">'views/'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $view_cascade</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_view_paths</span><span class="pun">;</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">$config </span><span class="pun">=&amp;</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_get_component</span><span class="pun">(</span><span class="str">'config'</span><span class="pun">);</span></li><li class="L9"><span class="pln">array_unshift</span><span class="pun">(</span><span class="pln">$config</span><span class="pun">-&gt;</span><span class="pln">_config_paths</span><span class="pun">,</span><span class="pln"> $path</span><span class="pun">);</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">// --------------------------------------------------------------------</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/**</span></li><li class="L5"><span class="com">* Get Package Paths</span></li><li class="L6"><span class="com">*</span></li><li class="L7"><span class="com">*/</span></li><li class="L8"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> get_package_paths</span><span class="pun">(</span><span class="pln">$include_base </span><span class="pun">=</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="kwd">return</span><span class="pln"> $include_base </span><span class="pun">===</span><span class="pln"> TRUE </span><span class="pun">?</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_library_paths </span><span class="pun">:</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_model_paths</span><span class="pun">;</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">// --------------------------------------------------------------------</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/**</span></li><li class="L6"><span class="com">* Remove Package Path</span></li><li class="L7"><span class="com">*/</span></li><li class="L8"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> remove_package_path</span><span class="pun">(</span><span class="pln">$path </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> $remove_config_path </span><span class="pun">=</span><span class="pln"> TRUE</span><span class="pun">)</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln">$config </span><span class="pun">=&amp;</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_get_component</span><span class="pun">(</span><span class="str">'config'</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$path </span><span class="pun">==</span><span class="pln"> </span><span class="str">''</span><span class="pun">)</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">$void </span><span class="pun">=</span><span class="pln"> array_shift</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_library_paths</span><span class="pun">);</span></li><li class="L5"><span class="pln">$void </span><span class="pun">=</span><span class="pln"> array_shift</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_model_paths</span><span class="pun">);</span></li><li class="L6"><span class="pln">$void </span><span class="pun">=</span><span class="pln"> array_shift</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_helper_paths</span><span class="pun">);</span></li><li class="L7"><span class="pln">$void </span><span class="pun">=</span><span class="pln"> array_shift</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_view_paths</span><span class="pun">);</span></li><li class="L8"><span class="pln">$void </span><span class="pun">=</span><span class="pln"> array_shift</span><span class="pun">(</span><span class="pln">$config</span><span class="pun">-&gt;</span><span class="pln">_config_paths</span><span class="pun">);</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="kwd">else</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">$path </span><span class="pun">=</span><span class="pln"> rtrim</span><span class="pun">(</span><span class="pln">$path</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/'</span><span class="pun">).</span><span class="str">'/'</span><span class="pun">;</span></li><li class="L3"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">array</span><span class="pun">(</span><span class="str">'_ci_library_paths'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'_ci_model_paths'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'_ci_helper_paths'</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> $var</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">$key </span><span class="pun">=</span><span class="pln"> array_search</span><span class="pun">(</span><span class="pln">$path</span><span class="pun">,</span><span class="pln"> $this</span><span class="pun">-&gt;{</span><span class="pln">$var</span><span class="pun">}))</span><span class="pln"> </span><span class="pun">!==</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">unset</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;{</span><span class="pln">$var</span><span class="pun">}[</span><span class="pln">$key</span><span class="pun">]);</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_view_paths</span><span class="pun">[</span><span class="pln">$path</span><span class="pun">.</span><span class="str">'views/'</span><span class="pun">]))</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">unset</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_view_paths</span><span class="pun">[</span><span class="pln">$path</span><span class="pun">.</span><span class="str">'views/'</span><span class="pun">]);</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">$key </span><span class="pun">=</span><span class="pln"> array_search</span><span class="pun">(</span><span class="pln">$path</span><span class="pun">,</span><span class="pln"> $config</span><span class="pun">-&gt;</span><span class="pln">_config_paths</span><span class="pun">))</span><span class="pln"> </span><span class="pun">!==</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">unset</span><span class="pun">(</span><span class="pln">$config</span><span class="pun">-&gt;</span><span class="pln">_config_paths</span><span class="pun">[</span><span class="pln">$key</span><span class="pun">]);</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_library_paths </span><span class="pun">=</span><span class="pln"> array_unique</span><span class="pun">(</span><span class="pln">array_merge</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_library_paths</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">,</span><span class="pln"> BASEPATH</span><span class="pun">)));</span></li><li class="L3"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_helper_paths </span><span class="pun">=</span><span class="pln"> array_unique</span><span class="pun">(</span><span class="pln">array_merge</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_helper_paths</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">,</span><span class="pln"> BASEPATH</span><span class="pun">)));</span></li><li class="L4"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_model_paths </span><span class="pun">=</span><span class="pln"> array_unique</span><span class="pun">(</span><span class="pln">array_merge</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_model_paths</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">)));</span></li><li class="L5"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_view_paths </span><span class="pun">=</span><span class="pln"> array_merge</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_view_paths</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">.</span><span class="str">'views/'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> TRUE</span><span class="pun">));</span></li><li class="L6"><span class="pln">$config</span><span class="pun">-&gt;</span><span class="pln">_config_paths </span><span class="pun">=</span><span class="pln"> array_unique</span><span class="pun">(</span><span class="pln">array_merge</span><span class="pun">(</span><span class="pln">$config</span><span class="pun">-&gt;</span><span class="pln">_config_paths</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">)));</span></li><li class="L7"><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">// --------------------------------------------------------------------</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">/**</span></li><li class="L2"><span class="com">* Loader</span></li><li class="L3"><span class="com">*/</span></li><li class="L4"><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> _ci_load</span><span class="pun">(</span><span class="pln">$_ci_data</span><span class="pun">)</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="com">//这里相当于把数组里面的元素拆开成变量。</span></li><li class="L7"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">array</span><span class="pun">(</span><span class="str">'_ci_view'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'_ci_vars'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'_ci_path'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'_ci_return'</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> $_ci_val</span><span class="pun">)</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln">$$_ci_val </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> isset</span><span class="pun">(</span><span class="pln">$_ci_data</span><span class="pun">[</span><span class="pln">$_ci_val</span><span class="pun">]))</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> FALSE </span><span class="pun">:</span><span class="pln"> $_ci_data</span><span class="pun">[</span><span class="pln">$_ci_val</span><span class="pun">];</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">$file_exists </span><span class="pun">=</span><span class="pln"> FALSE</span><span class="pun">;</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">//当Loader::_ci_load()方法是通过Loader::file()调用的时候，则会有$_ci_path的值，如果是</span></li><li class="L5"><span class="com">//如果Loader::view()调用的话，则有$_ci_view的值。</span></li><li class="L6"><span class="com">//如果$_ci_path不为空，则说明当前要加载普通文件。</span></li><li class="L7"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$_ci_path </span><span class="pun">!=</span><span class="pln"> </span><span class="str">''</span><span class="pun">)</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="com">//普通文件。这里只是获得文件名，以便找不到报错时候只报文件名而已。</span></li><li class="L0"><span class="pln">$_ci_x </span><span class="pun">=</span><span class="pln"> explode</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">,</span><span class="pln"> $_ci_path</span><span class="pun">);</span></li><li class="L1"><span class="pln">$_ci_file </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">end</span><span class="pun">(</span><span class="pln">$_ci_x</span><span class="pun">);</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="kwd">else</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="com">//视图文件。</span></li><li class="L6"><span class="com">//下面两行操作也是为了让外部可以通过xxx.php或者直接xxx的方式进行传参而已。</span></li><li class="L7"><span class="pln">$_ci_ext </span><span class="pun">=</span><span class="pln"> pathinfo</span><span class="pun">(</span><span class="pln">$_ci_view</span><span class="pun">,</span><span class="pln"> PATHINFO_EXTENSION</span><span class="pun">);</span></li><li class="L8"><span class="pln">$_ci_file </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$_ci_ext </span><span class="pun">==</span><span class="pln"> </span><span class="str">''</span><span class="pun">)</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> $_ci_view</span><span class="pun">.</span><span class="str">'.php'</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> $_ci_view</span><span class="pun">;</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_view_paths </span><span class="kwd">as</span><span class="pln"> $view_file </span><span class="pun">=&gt;</span><span class="pln"> $cascade</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="com">//从Loader::$_ci_view_paths中遍历视图文件，如果找到则退出。</span></li><li class="L3"><span class="com">//（默认仅有APPPATH/view/下，当然也可以通过Loader::add_package()方法设置）</span></li><li class="L4"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">file_exists</span><span class="pun">(</span><span class="pln">$view_file</span><span class="pun">.</span><span class="pln">$_ci_file</span><span class="pun">))</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="pln">$_ci_path </span><span class="pun">=</span><span class="pln"> $view_file</span><span class="pun">.</span><span class="pln">$_ci_file</span><span class="pun">;</span></li><li class="L7"><span class="pln">$file_exists </span><span class="pun">=</span><span class="pln"> TRUE</span><span class="pun">;</span></li><li class="L8"><span class="kwd">break</span><span class="pun">;</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">//如果没有找到，会根据这个$cascade判断允不允许继续往下一个路径寻找视图文件。</span></li><li class="L2"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> $cascade</span><span class="pun">)</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="kwd">break</span><span class="pun">;</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">//如果找不到文件（普通或视图都一样），则报错。</span></li><li class="L0"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> $file_exists </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> file_exists</span><span class="pun">(</span><span class="pln">$_ci_path</span><span class="pun">))</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">show_error</span><span class="pun">(</span><span class="str">'Unable to load the requested file: '</span><span class="pun">.</span><span class="pln">$_ci_file</span><span class="pun">);</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">//下面这个也很关键，其实视图文件里面的代码都是在属于Loader组件的，什么意思？</span></li><li class="L6"><span class="com">//你可以随便写一个视图文件，然后在里面写上var_dump($this);可以发现，这个$this，是指Loader。</span></li><li class="L7"><span class="com">//为什么会这样子呢？再往下面十几行代码的地方就说明了这一点。</span></li><li class="L8"><span class="com">//这里是把CI所有的属性都开放给Loader组件用，这样在视图文件里面就可以通过$this-&gt;xxx的方式调用控制器</span></li><li class="L9"><span class="com">//所有的东西。</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">$_ci_CI </span><span class="pun">=&amp;</span><span class="pln"> get_instance</span><span class="pun">();</span></li><li class="L2"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">get_object_vars</span><span class="pun">(</span><span class="pln">$_ci_CI</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> $_ci_key </span><span class="pun">=&gt;</span><span class="pln"> $_ci_var</span><span class="pun">)</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> isset</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">$_ci_key</span><span class="pun">))</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">$_ci_key </span><span class="pun">=&amp;</span><span class="pln"> $_ci_CI</span><span class="pun">-&gt;</span><span class="pln">$_ci_key</span><span class="pun">;</span></li><li class="L7"><span class="pun">}</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">//在这里把在控制器里面通过$this-&gt;load-&gt;view("xxx",$data);中的$data解开，这就是为什么可以在视图文件</span></li><li class="L1"><span class="com">//中可以用$data里面的变量的原因。其实还可以通过Loader::vars()方法，设置这些变量，它们会首先保存在</span></li><li class="L2"><span class="com">//Loader::$_ci_cached_vars中</span></li><li class="L3"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">is_array</span><span class="pun">(</span><span class="pln">$_ci_vars</span><span class="pun">))</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_cached_vars </span><span class="pun">=</span><span class="pln"> array_merge</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_cached_vars</span><span class="pun">,</span><span class="pln"> $_ci_vars</span><span class="pun">);</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln">extract</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_cached_vars</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">//我们在控制器中调用$this-&gt;load-&gt;view()方法，实质视图并没有马上输出来，而是先将它放到缓冲区。</span></li><li class="L0"><span class="pln">ob_start</span><span class="pun">();</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">//就是这个地方，下面if中有一句eval(xxxx)以及else中有include;而里面的xxxx正是我们要加载的视图文件，</span></li><li class="L3"><span class="com">//所以这就是为什么在视图文件里，var_dump($this)，会告诉你当前这个$this是Loader组件，因为视图的代码都是相当于</span></li><li class="L4"><span class="com">//嵌入这个地方。</span></li><li class="L5"><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="kwd">bool</span><span class="pun">)</span><span class="pln"> </span><span class="lit">@ini_get</span><span class="pun">(</span><span class="str">'short_open_tag'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">===</span><span class="pln"> FALSE AND config_item</span><span class="pun">(</span><span class="str">'rewrite_short_tags'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> TRUE</span><span class="pun">)</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">echo </span><span class="kwd">eval</span><span class="pun">(</span><span class="str">'</span><span class="pun">?&gt;</span><span class="pln">'.preg_replace("/;*\s*\</span><span class="pun">?&gt;</span><span class="pln">/", "; </span><span class="pun">?&gt;</span><span class="pln">", str_replace('</span><span class="pun">&lt;?=</span><span class="str">', '</span><span class="pun">&lt;?</span><span class="pln">php echo </span><span class="str">', file_get_contents($_ci_path))));//'</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="kwd">else</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">include</span><span class="pun">(</span><span class="pln">$_ci_path</span><span class="pun">);</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">//经过上面的代码，我们的视图文件的内容已经放到了缓冲区了。</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">log_message</span><span class="pun">(</span><span class="str">'debug'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'File loaded: '</span><span class="pun">.</span><span class="pln">$_ci_path</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">//一般情况下，$_ci_return都为FLASE，即不要求通过$this-&gt;load-&gt;view()返回输出内容，而是直接放到缓冲区静候处理;</span></li><li class="L9"><span class="com">//当然你也可以先拿出数据，在控制器里面处理一下，再输出，例如在控制器中</span></li><li class="L0"><span class="com">//$output=$this-&gt;load-&gt;view("x",$data,TRUE);，当为TRUE的时候，下面的代码就起作用了。</span></li><li class="L1"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$_ci_return </span><span class="pun">===</span><span class="pln"> TRUE</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">$buffer </span><span class="pun">=</span><span class="pln"> ob_get_contents</span><span class="pun">();</span></li><li class="L4"><span class="lit">@ob_end_clean</span><span class="pun">();</span></li><li class="L5"><span class="kwd">return</span><span class="pln"> $buffer</span><span class="pun">;</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">//下面这个很关键，因为有可能当前这个视图文件是被另一个视图文件通过$this-&gt;view()方法引入，即视图文件嵌入视图文件</span></li><li class="L9"><span class="com">//从而导致多了一层缓冲。</span></li><li class="L0"><span class="com">//为了保证缓冲内容最后交给Output处理时，缓冲级别只比Loader组件加载时多1（这个1就是最父层的视图文件引起的）</span></li><li class="L1"><span class="com">//这里必须先flush掉当前层视图引起的这次缓冲，以保证Output正常工作。</span></li><li class="L2"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">ob_get_level</span><span class="pun">()</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_ob_level </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">ob_end_flush</span><span class="pun">();</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="kwd">else</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="com">//如果不是多1，则说明当前引入的视图文件就是直接在控制器里面引入的那个，而不是由某个视图文件再引入的。</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">//把缓冲区的内容交给Output组件并清空关闭缓冲区。</span></li><li class="L1"><span class="pln">$_ci_CI</span><span class="pun">-&gt;</span><span class="pln">output</span><span class="pun">-&gt;</span><span class="pln">append_output</span><span class="pun">(</span><span class="pln">ob_get_contents</span><span class="pun">());</span></li><li class="L2"><span class="lit">@ob_end_clean</span><span class="pun">();</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// --------------------------------------------------------------------</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/**</span></li><li class="L9"><span class="com">* Load class</span></li><li class="L0"><span class="com">*/</span></li><li class="L1"><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> _ci_load_class</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">,</span><span class="pln"> $params </span><span class="pun">=</span><span class="pln"> NULL</span><span class="pun">,</span><span class="pln"> $object_name </span><span class="pun">=</span><span class="pln"> NULL</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="com">//去掉后缀.php，是为了方便外部可以通过xxx.php也可以通过xxx.php来传入类名。同时去掉两端的/。</span></li><li class="L4"><span class="pln">$class </span><span class="pun">=</span><span class="pln"> str_replace</span><span class="pun">(</span><span class="str">'.php'</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> trim</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/'</span><span class="pun">));</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">//因为CI允许通过"dir1/dir2/classname"的格式来组织和加载类，所以还要判断类名中是否包括这些目录信息。</span></li><li class="L7"><span class="pln">$subdir </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">;</span></li><li class="L8"><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">$last_slash </span><span class="pun">=</span><span class="pln"> strrpos</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/'</span><span class="pun">))</span><span class="pln"> </span><span class="pun">!==</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="com">//目录部分</span></li><li class="L1"><span class="pln">$subdir </span><span class="pun">=</span><span class="pln"> substr</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> $last_slash </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">//类名部分</span></li><li class="L4"><span class="pln">$class </span><span class="pun">=</span><span class="pln"> substr</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">,</span><span class="pln"> $last_slash </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">//CI允许类文件以大写字母开头或者全小写，下面的遍历，就是在遍历这两种情况。</span></li><li class="L8"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">array</span><span class="pun">(</span><span class="pln">ucfirst</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">),</span><span class="pln"> strtolower</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">))</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> $class</span><span class="pun">)</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln">$subclass </span><span class="pun">=</span><span class="pln"> APPPATH</span><span class="pun">.</span><span class="str">'libraries/'</span><span class="pun">.</span><span class="pln">$subdir</span><span class="pun">.</span><span class="pln">config_item</span><span class="pun">(</span><span class="str">'subclass_prefix'</span><span class="pun">).</span><span class="pln">$class</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">;</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">//是否有我们开发人员自己写的扩展当前类的扩展？如果有的话，把它加载进来。</span></li><li class="L3"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">file_exists</span><span class="pun">(</span><span class="pln">$subclass</span><span class="pun">))</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="com">//先加载父类。</span></li><li class="L6"><span class="pln">$baseclass </span><span class="pun">=</span><span class="pln"> BASEPATH</span><span class="pun">.</span><span class="str">'libraries/'</span><span class="pun">.</span><span class="pln">ucfirst</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">).</span><span class="str">'.php'</span><span class="pun">;</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> file_exists</span><span class="pun">(</span><span class="pln">$baseclass</span><span class="pun">))</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln">log_message</span><span class="pun">(</span><span class="str">'error'</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Unable to load the requested class: "</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">);</span></li><li class="L1"><span class="pln">show_error</span><span class="pun">(</span><span class="str">"Unable to load the requested class: "</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">);</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">in_array</span><span class="pun">(</span><span class="pln">$subclass</span><span class="pun">,</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_loaded_files</span><span class="pun">))</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> is_null</span><span class="pun">(</span><span class="pln">$object_name</span><span class="pun">))</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln">$CI </span><span class="pun">=&amp;</span><span class="pln"> get_instance</span><span class="pun">();</span></li><li class="L0"><span class="com">//我们加载的类最终都是加载给超级控制器的，如果超级控制器已经有的话，那么我们没必要加载。</span></li><li class="L1"><span class="com">//如果没有，则实例它并加载给控制器。，</span></li><li class="L2"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> isset</span><span class="pun">(</span><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">$object_name</span><span class="pun">))</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_init_class</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">,</span><span class="pln"> config_item</span><span class="pun">(</span><span class="str">'subclass_prefix'</span><span class="pun">),</span><span class="pln"> $params</span><span class="pun">,</span><span class="pln"> $object_name</span><span class="pun">);</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">$is_duplicate </span><span class="pun">=</span><span class="pln"> TRUE</span><span class="pun">;</span></li><li class="L9"><span class="pln">log_message</span><span class="pun">(</span><span class="str">'debug'</span><span class="pun">,</span><span class="pln"> $class</span><span class="pun">.</span><span class="str">" class already loaded. Second attempt ignored."</span><span class="pun">);</span></li><li class="L0"><span class="kwd">return</span><span class="pun">;</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">//加载类。</span></li><li class="L4"><span class="pln">include_once</span><span class="pun">(</span><span class="pln">$baseclass</span><span class="pun">);</span></li><li class="L5"><span class="pln">include_once</span><span class="pun">(</span><span class="pln">$subclass</span><span class="pun">);</span></li><li class="L6"><span class="com">//把已加载的类记录到Loader::_ci_loaded_files中。</span></li><li class="L7"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_loaded_files</span><span class="pun">[]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> $subclass</span><span class="pun">;</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">//调用Loader::_ci_init_class()方法进而实例化。</span></li><li class="L0"><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_init_class</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">,</span><span class="pln"> config_item</span><span class="pun">(</span><span class="str">'subclass_prefix'</span><span class="pun">),</span><span class="pln"> $params</span><span class="pun">,</span><span class="pln"> $object_name</span><span class="pun">);</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">//如果是没有写扩展。方法和上面大致相同，最后都是通过调用Loader::_ci_init_class()方法进而实例化。</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">$is_duplicate </span><span class="pun">=</span><span class="pln"> FALSE</span><span class="pun">;</span></li><li class="L6"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_library_paths </span><span class="kwd">as</span><span class="pln"> $path</span><span class="pun">)</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">$filepath </span><span class="pun">=</span><span class="pln"> $path</span><span class="pun">.</span><span class="str">'libraries/'</span><span class="pun">.</span><span class="pln">$subdir</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">;</span></li><li class="L9"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> file_exists</span><span class="pun">(</span><span class="pln">$filepath</span><span class="pun">))</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="kwd">continue</span><span class="pun">;</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">in_array</span><span class="pun">(</span><span class="pln">$filepath</span><span class="pun">,</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_loaded_files</span><span class="pun">))</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> is_null</span><span class="pun">(</span><span class="pln">$object_name</span><span class="pun">))</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">$CI </span><span class="pun">=&amp;</span><span class="pln"> get_instance</span><span class="pun">();</span></li><li class="L9"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> isset</span><span class="pun">(</span><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">$object_name</span><span class="pun">))</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_init_class</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> $params</span><span class="pun">,</span><span class="pln"> $object_name</span><span class="pun">);</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">$is_duplicate </span><span class="pun">=</span><span class="pln"> TRUE</span><span class="pun">;</span></li><li class="L6"><span class="pln">log_message</span><span class="pun">(</span><span class="str">'debug'</span><span class="pun">,</span><span class="pln"> $class</span><span class="pun">.</span><span class="str">" class already loaded. Second attempt ignored."</span><span class="pun">);</span></li><li class="L7"><span class="kwd">return</span><span class="pun">;</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">include_once</span><span class="pun">(</span><span class="pln">$filepath</span><span class="pun">);</span></li><li class="L1"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_loaded_files</span><span class="pun">[]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> $filepath</span><span class="pun">;</span></li><li class="L2"><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_init_class</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> $params</span><span class="pun">,</span><span class="pln"> $object_name</span><span class="pun">);</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pun">}</span><span class="pln"> </span><span class="com">// END FOREACH</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">//其实正常的话，上面如果找到此类就找到，没找到就没有了。不过CI在会这里做最后的尝试。会不会是放到了一个同名的</span></li><li class="L8"><span class="com">//子目录下。</span></li><li class="L9"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$subdir </span><span class="pun">==</span><span class="pln"> </span><span class="str">''</span><span class="pun">)</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">$path </span><span class="pun">=</span><span class="pln"> strtolower</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">).</span><span class="str">'/'</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">;</span></li><li class="L2"><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_load_class</span><span class="pun">(</span><span class="pln">$path</span><span class="pun">,</span><span class="pln"> $params</span><span class="pun">);</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">//没有找到就报错咯。</span></li><li class="L6"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$is_duplicate </span><span class="pun">==</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">log_message</span><span class="pun">(</span><span class="str">'error'</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Unable to load the requested class: "</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">);</span></li><li class="L9"><span class="pln">show_error</span><span class="pun">(</span><span class="str">"Unable to load the requested class: "</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">);</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">// --------------------------------------------------------------------</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">//此方法是用于实例化已经把类文件include进来的类。</span></li><li class="L6"><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> _ci_init_class</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">,</span><span class="pln"> $prefix </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> $config </span><span class="pun">=</span><span class="pln"> FALSE</span><span class="pun">,</span><span class="pln"> $object_name </span><span class="pun">=</span><span class="pln"> NULL</span><span class="pun">)</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="com">// Is there an associated config file for this class? Note: these should always be lowercase</span></li><li class="L9"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$config </span><span class="pun">===</span><span class="pln"> NULL</span><span class="pun">)</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="com">// Fetch the config paths containing any package paths</span></li><li class="L2"><span class="pln">$config_component </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_get_component</span><span class="pun">(</span><span class="str">'config'</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">is_array</span><span class="pun">(</span><span class="pln">$config_component</span><span class="pun">-&gt;</span><span class="pln">_config_paths</span><span class="pun">))</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="com">// Break on the first found file, thus package files</span></li><li class="L7"><span class="com">// are not overridden by default paths</span></li><li class="L8"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$config_component</span><span class="pun">-&gt;</span><span class="pln">_config_paths </span><span class="kwd">as</span><span class="pln"> $path</span><span class="pun">)</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="com">// We test for both uppercase and lowercase, for servers that</span></li><li class="L1"><span class="com">// are case-sensitive with regard to file names. Check for environment</span></li><li class="L2"><span class="com">// first, global next</span></li><li class="L3"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">defined</span><span class="pun">(</span><span class="str">'ENVIRONMENT'</span><span class="pun">)</span><span class="pln"> AND file_exists</span><span class="pun">(</span><span class="pln">$path </span><span class="pun">.</span><span class="str">'config/'</span><span class="pun">.</span><span class="pln">ENVIRONMENT</span><span class="pun">.</span><span class="str">'/'</span><span class="pun">.</span><span class="pln">strtolower</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">).</span><span class="str">'.php'</span><span class="pun">))</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">include</span><span class="pun">(</span><span class="pln">$path </span><span class="pun">.</span><span class="str">'config/'</span><span class="pun">.</span><span class="pln">ENVIRONMENT</span><span class="pun">.</span><span class="str">'/'</span><span class="pun">.</span><span class="pln">strtolower</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">).</span><span class="str">'.php'</span><span class="pun">);</span></li><li class="L6"><span class="kwd">break</span><span class="pun">;</span></li><li class="L7"><span class="pun">}</span></li><li class="L8"><span class="pln">elseif </span><span class="pun">(</span><span class="kwd">defined</span><span class="pun">(</span><span class="str">'ENVIRONMENT'</span><span class="pun">)</span><span class="pln"> AND file_exists</span><span class="pun">(</span><span class="pln">$path </span><span class="pun">.</span><span class="str">'config/'</span><span class="pun">.</span><span class="pln">ENVIRONMENT</span><span class="pun">.</span><span class="str">'/'</span><span class="pun">.</span><span class="pln">ucfirst</span><span class="pun">(</span><span class="pln">strtolower</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">)).</span><span class="str">'.php'</span><span class="pun">))</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln">include</span><span class="pun">(</span><span class="pln">$path </span><span class="pun">.</span><span class="str">'config/'</span><span class="pun">.</span><span class="pln">ENVIRONMENT</span><span class="pun">.</span><span class="str">'/'</span><span class="pun">.</span><span class="pln">ucfirst</span><span class="pun">(</span><span class="pln">strtolower</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">)).</span><span class="str">'.php'</span><span class="pun">);</span></li><li class="L1"><span class="kwd">break</span><span class="pun">;</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">elseif </span><span class="pun">(</span><span class="pln">file_exists</span><span class="pun">(</span><span class="pln">$path </span><span class="pun">.</span><span class="str">'config/'</span><span class="pun">.</span><span class="pln">strtolower</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">).</span><span class="str">'.php'</span><span class="pun">))</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">include</span><span class="pun">(</span><span class="pln">$path </span><span class="pun">.</span><span class="str">'config/'</span><span class="pun">.</span><span class="pln">strtolower</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">).</span><span class="str">'.php'</span><span class="pun">);</span></li><li class="L6"><span class="kwd">break</span><span class="pun">;</span></li><li class="L7"><span class="pun">}</span></li><li class="L8"><span class="pln">elseif </span><span class="pun">(</span><span class="pln">file_exists</span><span class="pun">(</span><span class="pln">$path </span><span class="pun">.</span><span class="str">'config/'</span><span class="pun">.</span><span class="pln">ucfirst</span><span class="pun">(</span><span class="pln">strtolower</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">)).</span><span class="str">'.php'</span><span class="pun">))</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln">include</span><span class="pun">(</span><span class="pln">$path </span><span class="pun">.</span><span class="str">'config/'</span><span class="pun">.</span><span class="pln">ucfirst</span><span class="pun">(</span><span class="pln">strtolower</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">)).</span><span class="str">'.php'</span><span class="pun">);</span></li><li class="L1"><span class="kwd">break</span><span class="pun">;</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$prefix </span><span class="pun">==</span><span class="pln"> </span><span class="str">''</span><span class="pun">)</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">class_exists</span><span class="pun">(</span><span class="str">'CI_'</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">))</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">$name </span><span class="pun">=</span><span class="pln"> </span><span class="str">'CI_'</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">;</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">elseif </span><span class="pun">(</span><span class="pln">class_exists</span><span class="pun">(</span><span class="pln">config_item</span><span class="pun">(</span><span class="str">'subclass_prefix'</span><span class="pun">).</span><span class="pln">$class</span><span class="pun">))</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">$name </span><span class="pun">=</span><span class="pln"> config_item</span><span class="pun">(</span><span class="str">'subclass_prefix'</span><span class="pun">).</span><span class="pln">$class</span><span class="pun">;</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="kwd">else</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln">$name </span><span class="pun">=</span><span class="pln"> $class</span><span class="pun">;</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="kwd">else</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">$name </span><span class="pun">=</span><span class="pln"> $prefix</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">;</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">// Is the class name valid?</span></li><li class="L8"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> class_exists</span><span class="pun">(</span><span class="pln">$name</span><span class="pun">))</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln">log_message</span><span class="pun">(</span><span class="str">'error'</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Non-existent class: "</span><span class="pun">.</span><span class="pln">$name</span><span class="pun">);</span></li><li class="L1"><span class="pln">show_error</span><span class="pun">(</span><span class="str">"Non-existent class: "</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">);</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">// Set the variable name we will assign the class to</span></li><li class="L5"><span class="com">// Was a custom class name supplied? If so we'll use it</span></li><li class="L6"><span class="pln">$class </span><span class="pun">=</span><span class="pln"> strtolower</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">is_null</span><span class="pun">(</span><span class="pln">$object_name</span><span class="pun">))</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln">$classvar </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> isset</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_varmap</span><span class="pun">[</span><span class="pln">$class</span><span class="pun">]))</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> $class </span><span class="pun">:</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">_ci_varmap</span><span class="pun">[</span><span class="pln">$class</span><span class="pun">];</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="kwd">else</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">$classvar </span><span class="pun">=</span><span class="pln"> $object_name</span><span class="pun">;</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">// Save the class name and object name</span></li><li class="L8"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">_ci_classes</span><span class="pun">[</span><span class="pln">$class</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> $classvar</span><span class="pun">;</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">// Instantiate the class</span></li><li class="L1"><span class="pln">$CI </span><span class="pun">=&amp;</span><span class="pln"> get_instance</span><span class="pun">();</span></li><li class="L2"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$config </span><span class="pun">!==</span><span class="pln"> NULL</span><span class="pun">)</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">$classvar </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> $name</span><span class="pun">(</span><span class="pln">$config</span><span class="pun">);</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="kwd">else</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">$classvar </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> $name</span><span class="pun">;</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">// --------------------------------------------------------------------</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/**</span></li><li class="L5"><span class="com">* Autoloader</span></li><li class="L6"><span class="com">*</span></li><li class="L7"><span class="com">* The config/autoload.php file contains an array that permits sub-systems,</span></li><li class="L8"><span class="com">* libraries, and helpers to be loaded automatically.</span></li><li class="L9"><span class="com">*</span></li><li class="L0"><span class="com">*/</span></li><li class="L1"><span class="kwd">private</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> _ci_autoloader</span><span class="pun">()</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">defined</span><span class="pun">(</span><span class="str">'ENVIRONMENT'</span><span class="pun">)</span><span class="pln"> AND file_exists</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">.</span><span class="str">'config/'</span><span class="pun">.</span><span class="pln">ENVIRONMENT</span><span class="pun">.</span><span class="str">'/autoload.php'</span><span class="pun">))</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">include</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">.</span><span class="str">'config/'</span><span class="pun">.</span><span class="pln">ENVIRONMENT</span><span class="pun">.</span><span class="str">'/autoload.php'</span><span class="pun">);</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="kwd">else</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln">include</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">.</span><span class="str">'config/autoload.php'</span><span class="pun">);</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> isset</span><span class="pun">(</span><span class="pln">$autoload</span><span class="pun">))</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="kwd">return</span><span class="pln"> FALSE</span><span class="pun">;</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">// Autoload packages</span></li><li class="L8"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$autoload</span><span class="pun">[</span><span class="str">'packages'</span><span class="pun">]))</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$autoload</span><span class="pun">[</span><span class="str">'packages'</span><span class="pun">]</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> $package_path</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">add_package_path</span><span class="pun">(</span><span class="pln">$package_path</span><span class="pun">);</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// Load any custom config file</span></li><li class="L7"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">count</span><span class="pun">(</span><span class="pln">$autoload</span><span class="pun">[</span><span class="str">'config'</span><span class="pun">])</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln">$CI </span><span class="pun">=&amp;</span><span class="pln"> get_instance</span><span class="pun">();</span></li><li class="L0"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$autoload</span><span class="pun">[</span><span class="str">'config'</span><span class="pun">]</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> $key </span><span class="pun">=&gt;</span><span class="pln"> $val</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">$CI</span><span class="pun">-&gt;</span><span class="pln">config</span><span class="pun">-&gt;</span><span class="pln">load</span><span class="pun">(</span><span class="pln">$val</span><span class="pun">);</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// Autoload helpers and languages</span></li><li class="L7"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">array</span><span class="pun">(</span><span class="str">'helper'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'language'</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> $type</span><span class="pun">)</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$autoload</span><span class="pun">[</span><span class="pln">$type</span><span class="pun">])</span><span class="pln"> AND count</span><span class="pun">(</span><span class="pln">$autoload</span><span class="pun">[</span><span class="pln">$type</span><span class="pun">])</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">$type</span><span class="pun">(</span><span class="pln">$autoload</span><span class="pun">[</span><span class="pln">$type</span><span class="pun">]);</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">// A little tweak to remain backward compatible</span></li><li class="L6"><span class="com">// The $autoload['core'] item was deprecated</span></li><li class="L7"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> isset</span><span class="pun">(</span><span class="pln">$autoload</span><span class="pun">[</span><span class="str">'libraries'</span><span class="pun">])</span><span class="pln"> AND isset</span><span class="pun">(</span><span class="pln">$autoload</span><span class="pun">[</span><span class="str">'core'</span><span class="pun">]))</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln">$autoload</span><span class="pun">[</span><span class="str">'libraries'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> $autoload</span><span class="pun">[</span><span class="str">'core'</span><span class="pun">];</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">// Load libraries</span></li><li class="L3"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$autoload</span><span class="pun">[</span><span class="str">'libraries'</span><span class="pun">])</span><span class="pln"> AND count</span><span class="pun">(</span><span class="pln">$autoload</span><span class="pun">[</span><span class="str">'libraries'</span><span class="pun">])</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="com">// Load the database driver.</span></li><li class="L6"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">in_array</span><span class="pun">(</span><span class="str">'database'</span><span class="pun">,</span><span class="pln"> $autoload</span><span class="pun">[</span><span class="str">'libraries'</span><span class="pun">]))</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">database</span><span class="pun">();</span></li><li class="L9"><span class="pln">$autoload</span><span class="pun">[</span><span class="str">'libraries'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> array_diff</span><span class="pun">(</span><span class="pln">$autoload</span><span class="pun">[</span><span class="str">'libraries'</span><span class="pun">],</span><span class="pln"> array</span><span class="pun">(</span><span class="str">'database'</span><span class="pun">));</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">// Load all other libraries</span></li><li class="L3"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$autoload</span><span class="pun">[</span><span class="str">'libraries'</span><span class="pun">]</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> $item</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">library</span><span class="pun">(</span><span class="pln">$item</span><span class="pun">);</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">// Autoload models</span></li><li class="L0"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$autoload</span><span class="pun">[</span><span class="str">'model'</span><span class="pun">]))</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">model</span><span class="pun">(</span><span class="pln">$autoload</span><span class="pun">[</span><span class="str">'model'</span><span class="pun">]);</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// --------------------------------------------------------------------</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/**</span></li><li class="L9"><span class="com">* Object to Array</span></li><li class="L0"><span class="com">*</span></li><li class="L1"><span class="com">* Takes an object as input and converts the class variables to array key/vals</span></li><li class="L2"><span class="com">*</span></li><li class="L3"><span class="com">*/</span></li><li class="L4"><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> _ci_object_to_array</span><span class="pun">(</span><span class="pln">$object</span><span class="pun">)</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">is_object</span><span class="pun">(</span><span class="pln">$object</span><span class="pun">))</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> get_object_vars</span><span class="pun">(</span><span class="pln">$object</span><span class="pun">)</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> $object</span><span class="pun">;</span></li><li class="L7"><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">// --------------------------------------------------------------------</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">/**</span></li><li class="L2"><span class="com">* Get a reference to a specific library or model</span></li><li class="L3"><span class="com">*</span></li><li class="L4"><span class="com">*/</span></li><li class="L5"><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">_ci_get_component</span><span class="pun">(</span><span class="pln">$component</span><span class="pun">)</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">$CI </span><span class="pun">=&amp;</span><span class="pln"> get_instance</span><span class="pun">();</span></li><li class="L8"><span class="kwd">return</span><span class="pln"> $CI</span><span class="pun">-&gt;</span><span class="pln">$component</span><span class="pun">;</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">// --------------------------------------------------------------------</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">/**</span></li><li class="L4"><span class="com">* Prep filename</span></li><li class="L5"><span class="com">*</span></li><li class="L6"><span class="com">* This function preps the name of various items to make loading them more reliable.</span></li><li class="L7"><span class="com">*</span></li><li class="L8"><span class="com">*/</span></li><li class="L9"><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> _ci_prep_filename</span><span class="pun">(</span><span class="pln">$filename</span><span class="pun">,</span><span class="pln"> $extension</span><span class="pun">)</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> is_array</span><span class="pun">(</span><span class="pln">$filename</span><span class="pun">))</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="kwd">return</span><span class="pln"> array</span><span class="pun">(</span><span class="pln">strtolower</span><span class="pun">(</span><span class="pln">str_replace</span><span class="pun">(</span><span class="str">'.php'</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> str_replace</span><span class="pun">(</span><span class="pln">$extension</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> $filename</span><span class="pun">)).</span><span class="pln">$extension</span><span class="pun">));</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="kwd">else</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$filename </span><span class="kwd">as</span><span class="pln"> $key </span><span class="pun">=&gt;</span><span class="pln"> $val</span><span class="pun">)</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln">$filename</span><span class="pun">[</span><span class="pln">$key</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> strtolower</span><span class="pun">(</span><span class="pln">str_replace</span><span class="pun">(</span><span class="str">'.php'</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> str_replace</span><span class="pun">(</span><span class="pln">$extension</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> $val</span><span class="pun">)).</span><span class="pln">$extension</span><span class="pun">);</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">return</span><span class="pln"> $filename</span><span class="pun">;</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pun">}</span></li></ol></pre>
<p>转载请注明：<a href="http://calixwu.com/" data-original-title="" title="">Calix</a> » <a href="./CodeIgniter源码分析之Loader.php – Calix的博客_files/CodeIgniter源码分析之Loader.php – Calix的博客.html" data-original-title="" title="">CodeIgniter源码分析之Loader.php</a></p>

      
<div class="article-social">
			<a href="javascript:;" data-action="ding" data-id="10" id="Addlike" class="action" data-original-title="" title=""><i class="fa fa-heart-o"></i>喜欢 (<span class="count">4</span>)</a><span class="or">or</span><span class="action action-share bdsharebuttonbox bdshare-button-style0-24" data-bd-bind="1467157034181"><i class="fa fa-share-alt"></i>分享 (<span class="bds_count" data-cmd="count" title="累计分享0次">0</span>)<div class="action-popover"><div class="popover top in"><div class="arrow"></div><div class="popover-content"><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-loader.html#" class="sinaweibo fa fa-weibo" data-cmd="tsina" title="" data-original-title="分享到新浪微博"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-loader.html#" class="bds_qzone fa fa-star" data-cmd="qzone" title="" data-original-title="分享到QQ空间"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-loader.html#" class="tencentweibo fa fa-tencent-weibo" data-cmd="tqq" title="" data-original-title="分享到腾讯微博"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-loader.html#" class="qq fa fa-qq" data-cmd="sqq" title="" data-original-title="分享到QQ好友"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-loader.html#" class="bds_renren fa fa-renren" data-cmd="renren" title="" data-original-title="分享到人人网"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-loader.html#" class="bds_weixin fa fa-weixin" data-cmd="weixin" title="" data-original-title="分享到微信"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-loader.html#" class="bds_more fa fa-ellipsis-h" data-cmd="more" data-original-title="" title=""></a></div></div></div></span>	
</div>
	</article>	
				<footer class="article-footer">
			<div class="article-tags"><i class="fa fa-tags"></i><a href="http://calixwu.com/tag/codeigniter" rel="tag" data-original-title="" title="">CodeIgniter</a><a href="http://calixwu.com/tag/loader" rel="tag" data-original-title="" title="">loader</a><a href="http://calixwu.com/tag/mvc" rel="tag" data-original-title="" title="">MVC</a><a href="http://calixwu.com/tag/%e5%8a%a0%e8%bd%bd%e5%99%a8" rel="tag" data-original-title="" title="">加载器</a><a href="http://calixwu.com/tag/%e6%a1%86%e6%9e%b6" rel="tag" data-original-title="" title="">框架</a><a href="http://calixwu.com/tag/%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" rel="tag" data-original-title="" title="">源码分析</a></div></footer>
	<nav class="article-nav">
			<span class="article-nav-prev"></span>
			<span class="article-nav-next"><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-model-php.html" rel="next">CodeIgniter源码分析之Model.php</a>  <i class="fa fa-angle-double-right"></i></span>
		</nav>

		<div class="related_top">
			<div class="related_posts">

<div class="relates">
<ul>
<li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi.html">Memcached源码分析</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-from-set.html">Memcached源码分析之从SET命令开始说起</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-xianchengmoxing.html">Memcached源码分析之线程模型</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-qingqiuchuli-zhuangtaiji.html">Memcached源码分析之请求处理（状态机）</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-neicunguanli.html">Memcached源码分析之内存管理</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-memcached-h.html">Memcached源码分析之memcached.h</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-memcached-c.html">Memcached源码分析之memcached.c</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-thread-c.html">Memcached源码分析之thread.c</a></li>
</ul></div></div>		</div>
						<div id="respond" class="no_webshot">
		<form action="http://calixwu.com/wp-comments-post.php" method="post" id="commentform">
		
		<div class="comt-title">
			<div class="comt-avatar pull-left">
				<img src="./CodeIgniter源码分析之Loader.php – Calix的博客_files/m32.gif" class="avatar avatar-0" height="54px" width="54px">			</div>
			<div class="comt-author pull-left">
			发表我的评论			</div>
			<a id="cancel-comment-reply-link" class="pull-right" href="javascript:;">取消评论</a>
		</div>
		
		<div class="comt">
			<div class="comt-box">
				<textarea placeholder="写点什么..." class="input-block-level comt-area" name="comment" id="comment" cols="100%" rows="3" tabindex="1" onkeydown="if(event.ctrlKey&amp;&amp;event.keyCode==13){document.getElementById(&#39;submit&#39;).click();return false};"></textarea>
				<div class="comt-ctrl">
					<button class="btn btn-primary pull-right" type="submit" name="submit" id="submit" tabindex="5"><i class="fa fa-check-square-o"></i> 提交评论</button>
					<div class="comt-tips pull-right"><input type="hidden" name="comment_post_ID" value="10" id="comment_post_ID">
<input type="hidden" name="comment_parent" id="comment_parent" value="0">
<div class="comt-tip comt-loading" style="display: none;">正在提交, 请稍候...</div><div class="comt-tip comt-error" style="display: none;">#</div></div>
					<span data-type="comment-insert-smilie" class="muted comt-smilie"><i class="fa fa-smile-o"></i> 表情</span>
					<span class="muted comt-mailme"><label for="comment_mail_notify" class="checkbox inline" style="padding-top:0"><input type="checkbox" name="comment_mail_notify" id="comment_mail_notify" value="comment_mail_notify" checked="checked">有人回复时邮件通知我</label></span>
				</div>
			</div>

												<div class="comt-comterinfo" id="comment-author-info">
						<h4>亲~ 写下昵称哦~</h4>
						<ul>
							<li class="form-inline"><label class="hide" for="author">昵称</label><input class="ipt" type="text" name="author" id="author" value="" tabindex="2" placeholder="昵称"><span class="help-inline">昵称 (必填)</span></li>
						<!--	<li class="form-inline"><label class="hide" for="email">邮箱</label><input class="ipt" type="text" name="email" id="email" value="" tabindex="3" placeholder="邮箱"><span class="help-inline">邮箱 (必填)</span></li> -->
							<li class="form-inline"><label class="hide" for="url">网址</label><input class="ipt" type="text" name="url" id="url" value="" tabindex="4" placeholder="网址"><span class="help-inline">网址</span></li> 
						</ul>
					</div>
									</div>

		
	</form>
	</div>
<div id="postcomments">
	<div id="comments">
		<i class="fa fa-comments-o"></i> <b> (1)</b>个小伙伴在吐槽
	</div>
	<ol class="commentlist">
			</ol>
	<div class="commentnav">
			</div>
</div>
			</div>
</div>
<aside class="sidebar">	
<div class="widget widget_text"><div class="textwidget"><div class="social">
<a href="http://calixwu.com/feed" rel="external nofollow" target="_blank" title="" data-original-title="订阅本站"><i class="rss fa fa-rss"></i></a></div></div></div>

		<div class="widget widget_recent_entries">		<div class="title"><h2>近期文章</h2></div>		<ul>
					<li>
				<a href="http://calixwu.com/2014/11/memcached-yuanmafenxi.html">Memcached源码分析</a>
						</li>
					<li>
				<a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-from-set.html">Memcached源码分析之从SET命令开始说起</a>
						</li>
					<li>
				<a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-xianchengmoxing.html">Memcached源码分析之线程模型</a>
						</li>
					<li>
				<a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-qingqiuchuli-zhuangtaiji.html">Memcached源码分析之请求处理（状态机）</a>
						</li>
					<li>
				<a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-neicunguanli.html">Memcached源码分析之内存管理</a>
						</li>
				</ul>
		</div><div class="widget widget_categories"><div class="title"><h2>分类目录</h2></div>		<ul>
	<li class="cat-item cat-item-4"><a href="http://calixwu.com/category/codeigniter">CodeIgniter</a>
</li>
	<li class="cat-item cat-item-3"><a href="http://calixwu.com/category/memcached">Memcached</a>
</li>
		</ul>
</div></aside>
</section>
<footer class="footer">
    <div class="footer-inner">
        <div class="copyright pull-left">
        	<a href="http://calixwu.com/" title="Calix的博客">Calix的博客</a> 版权所有，保留一切权利 ·   基于<a href="http://cn.wordpress.org/">WordPress</a>构建   © 2014-2015

	</div>
        <div class="trackcode pull-right">
            <script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F77f536717c5f64cbc346960632d9eedb' type='text/javascript'%3E%3C/script%3E"));
</script><script src="./CodeIgniter源码分析之Loader.php – Calix的博客_files/h.js" type="text/javascript"></script><a href="http://tongji.baidu.com/hm-web/welcome/ico?s=77f536717c5f64cbc346960632d9eedb" target="_blank"><img border="0" src="./CodeIgniter源码分析之Loader.php – Calix的博客_files/21.gif" width="20" height="20"></a>

<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1254487188'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1254487188' type='text/javascript'%3E%3C/script%3E"));</script><span id="cnzz_stat_icon_1254487188"><a href="http://www.cnzz.com/stat/website.php?web_id=1254487188" target="_blank" title="站长统计">站长统计</a></span><script src="./CodeIgniter源码分析之Loader.php – Calix的博客_files/z_stat.php" type="text/javascript"></script><script src="./CodeIgniter源码分析之Loader.php – Calix的博客_files/core.php" charset="utf-8" type="text/javascript"></script>        </div>
    </div>
</footer>

<script>with(document)0[(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion="+~(-new Date()/36e5)];</script>

<div class="rollto"><button class="btn btn-inverse" data-type="totop" title="回顶部"><i class="fa fa-arrow-up"></i></button><button class="btn btn-inverse" data-type="torespond" title="发评论"><i class="fa fa-comment-o"></i></button></div></body></html>