<!DOCTYPE html>
<!-- saved from url=(0066)http://calixwu.com/2014/11/codeigniter-yuanmafenxi-common-php.html -->
<html><style type="text/css" id="89031809138"></style><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=10,IE=9,IE=8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
<title>CodeIgniter源码分析之Common.php – Calix的博客</title>
<script>
window._deel = {name: 'Calix',url: 'http://calixwu.com/wp-content/themes/yusi1.0', ajaxpager: '', commenton: 1, roll: [0,0]}
</script>
<meta name="author" content="calix,吴国清,calixwu">
<link rel="stylesheet" id="style-css" href="./CodeIgniter源码分析之Common.php – Calix的博客_files/style.css" type="text/css" media="all">
<script type="text/javascript" src="./CodeIgniter源码分析之Common.php – Calix的博客_files/jquery.min.js"></script>
<script type="text/javascript" src="./CodeIgniter源码分析之Common.php – Calix的博客_files/jquery.js"></script>
<link rel="prev" title="CodeIgniter源码分析之URI.php" href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-uri-php.html">
<link rel="next" title="CodeIgniter源码分析之CodeIgniter.php" href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-codeigniter-php.html">
<link rel="canonical" href="./CodeIgniter源码分析之Common.php – Calix的博客_files/CodeIgniter源码分析之Common.php – Calix的博客.html">
<link rel="shortlink" href="http://calixwu.com/?p=34">
<meta name="keywords" content="CodeIgniter, MVC, 框架, 源码分析, CodeIgniter">
<meta name="description" content="作者：Calix &lt;?php  if ( ! defined(&#39;BASEPATH&#39;)) exit(&#39;No direct script access allowed&#39;);  // ------------------------------------------------------------------------  /**  * Common Functions  */  /**  * 为什么还要定义这些全局函数呢？比如说">
<style type="text/css" id="syntaxhighlighteranchor"></style>
<!--[if lt IE 9]><script src="http://calixwu.com/wp-content/themes/yusi1.0/js/html5.js"></script><![endif]-->
<script src="./CodeIgniter源码分析之Common.php – Calix的博客_files/share.js"></script><link href="./CodeIgniter源码分析之Common.php – Calix的博客_files/share.css" rel="styleSheet" type="text/css"></head>
<body class="single single-post postid-34 single-format-standard">

<header id="header" class="header">
<div class="container-inner">
 <div class="yusi-logo">
                    <a href="http://calixwu.com/">
                        <h1>
                                                        <span class="yusi-mono">Calix</span>
                                                        <span class="yusi-bloger">善于总结。</span>
                                                    </h1>
                    </a>
    </div>
</div>

	<div id="nav-header" class="navbar">
		
		<ul class="nav">
			<li id="menu-item-4" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-4"><a href="http://calixwu.com/">首页</a></li>
<li style="float:right;">
                    <div class="toggle-search"><i class="fa fa-search"></i></div>
<div class="search-expand" style="display: none;"><div class="search-expand-inner"><form method="get" class="searchform themeform" onsubmit="location.href=&#39;http://calixwu.com/search/&#39; + encodeURIComponent(this.s.value).replace(/%20/g, &#39;+&#39;); return false;" action="http://calixwu.com/"><div> <input type="ext" class="search" name="s" onblur="if(this.value==&#39;&#39;)this.value=&#39;search...&#39;;" onfocus="if(this.value==&#39;search...&#39;)this.value=&#39;&#39;;" value="search..."></div></form></div></div>
</li>
		</ul><div class="screen-mini"><button data-type="screen-nav" class="btn btn-inverse screen-nav"><i class="fa fa-list"></i></button></div>
	</div>
</header>
<section class="container"><div class="speedbar">
				<div class="toptip"><strong class="text-success"><i class="fa fa-volume-up"></i> </strong> </div>
	</div>
	<div class="content-wrap">
	<div class="content">

				<header class="article-header">
			<h1 class="article-title"><a href="./CodeIgniter源码分析之Common.php – Calix的博客_files/CodeIgniter源码分析之Common.php – Calix的博客.html">CodeIgniter源码分析之Common.php</a></h1>
			<div class="meta">
				<span id="mute-category" class="muted"><i class="fa fa-list-alt"></i><a href="http://calixwu.com/category/codeigniter"> CodeIgniter</a></span>				<!--
				<span class="muted"><i class="fa fa-user"></i> <a href="http://calixwu.com/author/calix">calix</a></span>-->
				<time class="muted"><i class="fa fa-clock-o"></i> 2年前 (2014-11-19)</time>
				<span class="muted" style="color:#dd6666"><i class="fa fa-eye"></i> 1216℃</span>
											</div>
		</header>
		<article class="article-content">
			<p>作者：<a href="http://calixwu.com/" data-original-title="" title="">Calix</a></p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="pun">&lt;?</span><span class="pln">php  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> </span><span class="kwd">defined</span><span class="pun">(</span><span class="str">'BASEPATH'</span><span class="pun">))</span><span class="pln"> </span><span class="kwd">exit</span><span class="pun">(</span><span class="str">'No direct script access allowed'</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">// ------------------------------------------------------------------------</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/**</span></li><li class="L5"><span class="com"> * Common Functions</span></li><li class="L6"><span class="com"> */</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/**</span></li><li class="L9"><span class="com"> * 为什么还要定义这些全局函数呢？比如说，下面有很多函数，如get_config()、config_item()这两个方法不是应该由</span></li><li class="L0"><span class="com"> * core/Config.php这个组件去做么？那个load_class()不应该由core/Loader.php去做么？ 把这些函数定义出来貌似</span></li><li class="L1"><span class="com"> * 感觉架构变得不那么优雅，有点多余。</span></li><li class="L2"><span class="com"> * 其实是出于这样一种情况：</span></li><li class="L3"><span class="com"> * 比如说，如果一切和配置有关的动作都由Config组件来完成，一切加载的动作都由Loader来完成，</span></li><li class="L4"><span class="com"> * 试想一下，如果我要加载Config组件，那么，必须得通过Loader来加载，所以Loader必须比Config要更早实例化，</span></li><li class="L5"><span class="com"> * 但是如果Loader实例化的时候需要一些和Loader有关的配置信息才能实例化呢？那就必须通过Config来为它取得配置信息。</span></li><li class="L6"><span class="com"> * 这里就出现了鸡和鸡蛋的问题。。</span></li><li class="L7"><span class="com"> * 我之前写自己的框架也纠结过这样的问题，后来参考了YII框架，发现它里面其实都有同样的问题，它里面有个Exception的组件，</span></li><li class="L8"><span class="com"> * 但是在加载这个Exception组件之前，在加载其它组件的时候，如果出错了，那谁来处理异常和错误信息呢？答案就是先定义一些公共的函数。</span></li><li class="L9"><span class="com"> * 所以这些公共函数就很好地解决了这个问题，这也是为什么Common.php要很早被引入。</span></li><li class="L0"><span class="com"> *</span></li><li class="L1"><span class="com"> */</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">// ------------------------------------------------------------------------</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/**</span></li><li class="L6"><span class="com">* Determines if the current version of PHP is greater then the supplied value</span></li><li class="L7"><span class="com">*/</span></li><li class="L8"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> function_exists</span><span class="pun">(</span><span class="str">'is_php'</span><span class="pun">))</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln"> </span><span class="com">//判断当前php版本是不是$version以上的。调用version_compare()这个函数。</span></li><li class="L1"><span class="pln"> </span><span class="kwd">function</span><span class="pln"> is_php</span><span class="pun">(</span><span class="pln">$version </span><span class="pun">=</span><span class="pln"> </span><span class="str">'5.0.0'</span><span class="pun">)</span></li><li class="L2"><span class="pln"> </span><span class="pun">{</span></li><li class="L3"><span class="pln">  </span><span class="kwd">static</span><span class="pln"> $_is_php</span><span class="pun">;</span></li><li class="L4"><span class="pln">  $version </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">string</span><span class="pun">)</span><span class="pln">$version</span><span class="pun">;</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> isset</span><span class="pun">(</span><span class="pln">$_is_php</span><span class="pun">[</span><span class="pln">$version</span><span class="pun">]))</span></li><li class="L7"><span class="pln">  </span><span class="pun">{</span></li><li class="L8"><span class="pln">   </span><span class="com">//PHP_VERION能够获得当前php版本。</span></li><li class="L9"><span class="pln">   $_is_php</span><span class="pun">[</span><span class="pln">$version</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">version_compare</span><span class="pun">(</span><span class="pln">PHP_VERSION</span><span class="pun">,</span><span class="pln"> $version</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> FALSE </span><span class="pun">:</span><span class="pln"> TRUE</span><span class="pun">;</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $_is_php</span><span class="pun">[</span><span class="pln">$version</span><span class="pun">];</span></li><li class="L3"><span class="pln"> </span><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// ------------------------------------------------------------------------</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/**</span></li><li class="L9"><span class="com"> * Tests for file writability</span></li><li class="L0"><span class="com"> */</span></li><li class="L1"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> function_exists</span><span class="pun">(</span><span class="str">'is_really_writable'</span><span class="pun">))</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln"> </span><span class="com">//该函数和php官方手册上面写的差不多，兼容linux/Unix和windows系统：</span></li><li class="L4"><span class="pln"> </span><span class="com">//http://www.php.net/manual/en/function.is-writable.php</span></li><li class="L5"><span class="pln"> </span><span class="kwd">function</span><span class="pln"> is_really_writable</span><span class="pun">(</span><span class="pln">$file</span><span class="pun">)</span></li><li class="L6"><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">//DIRECTORY_SEPARATOR是系统的目录分割符。利用它的值可以知道当前是不是linux系统。</span></li><li class="L9"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">DIRECTORY_SEPARATOR </span><span class="pun">==</span><span class="pln"> </span><span class="str">'/'</span><span class="pln"> AND </span><span class="lit">@ini_get</span><span class="pun">(</span><span class="str">"safe_mode"</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L0"><span class="pln">  </span><span class="pun">{</span></li><li class="L1"><span class="pln">   </span><span class="com">//如果是linux系统的话，那么可以直接调用此方法来判断文件是否可写。</span></li><li class="L2"><span class="pln">   </span><span class="kwd">return</span><span class="pln"> is_writable</span><span class="pun">(</span><span class="pln">$file</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">//如果是windows系统，则尝试写入一个文件来判断。</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">is_dir</span><span class="pun">(</span><span class="pln">$file</span><span class="pun">))</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">   </span><span class="com">//如果是目录，则创建一个随机命名的文件。</span></li><li class="L0"><span class="pln">   $file </span><span class="pun">=</span><span class="pln"> rtrim</span><span class="pun">(</span><span class="pln">$file</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/'</span><span class="pun">).</span><span class="str">'/'</span><span class="pun">.</span><span class="pln">md5</span><span class="pun">(</span><span class="pln">mt_rand</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="lit">100</span><span class="pun">).</span><span class="pln">mt_rand</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="lit">100</span><span class="pun">));</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">   </span><span class="com">//如果文件不能创建，则返回不可写。</span></li><li class="L3"><span class="pln">   </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">$fp </span><span class="pun">=</span><span class="pln"> </span><span class="lit">@fopen</span><span class="pun">(</span><span class="pln">$file</span><span class="pun">,</span><span class="pln"> FOPEN_WRITE_CREATE</span><span class="pun">))</span><span class="pln"> </span><span class="pun">===</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L4"><span class="pln">   </span><span class="pun">{</span></li><li class="L5"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> FALSE</span><span class="pun">;</span></li><li class="L6"><span class="pln">   </span><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">   fclose</span><span class="pun">(</span><span class="pln">$fp</span><span class="pun">);</span></li><li class="L9"><span class="pln">   </span><span class="com">//删除刚才的文件。</span></li><li class="L0"><span class="pln">   </span><span class="lit">@chmod</span><span class="pun">(</span><span class="pln">$file</span><span class="pun">,</span><span class="pln"> DIR_WRITE_MODE</span><span class="pun">);</span></li><li class="L1"><span class="pln">   </span><span class="lit">@unlink</span><span class="pun">(</span><span class="pln">$file</span><span class="pun">);</span></li><li class="L2"><span class="pln">   </span><span class="kwd">return</span><span class="pln"> TRUE</span><span class="pun">;</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pln">  elseif </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> is_file</span><span class="pun">(</span><span class="pln">$file</span><span class="pun">)</span><span class="pln"> OR </span><span class="pun">(</span><span class="pln">$fp </span><span class="pun">=</span><span class="pln"> </span><span class="lit">@fopen</span><span class="pun">(</span><span class="pln">$file</span><span class="pun">,</span><span class="pln"> FOPEN_WRITE_CREATE</span><span class="pun">))</span><span class="pln"> </span><span class="pun">===</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L5"><span class="pln">  </span><span class="pun">{</span></li><li class="L6"><span class="pln">   </span><span class="com">//如果是一个文件，而通过写入方式打不开，则返回不可写。</span></li><li class="L7"><span class="pln">   </span><span class="kwd">return</span><span class="pln"> FALSE</span><span class="pun">;</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  fclose</span><span class="pun">(</span><span class="pln">$fp</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> TRUE</span><span class="pun">;</span></li><li class="L2"><span class="pln"> </span><span class="pun">}</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">// ------------------------------------------------------------------------</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">/**</span></li><li class="L8"><span class="com">* Class registry</span></li><li class="L9"><span class="com">*/</span></li><li class="L0"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> function_exists</span><span class="pun">(</span><span class="str">'load_class'</span><span class="pun">))</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln"> </span><span class="com">//加载类。默认是加载libraries里面的，如果要加载核心组件，$directory就为'core'</span></li><li class="L3"><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">load_class</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">,</span><span class="pln"> $directory </span><span class="pun">=</span><span class="pln"> </span><span class="str">'libraries'</span><span class="pun">,</span><span class="pln"> $prefix </span><span class="pun">=</span><span class="pln"> </span><span class="str">'CI_'</span><span class="pun">)</span></li><li class="L4"><span class="pln"> </span><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="kwd">static</span><span class="pln"> $_classes </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span><span class="com">//用一个静态数组，保存已经加载过的类的实例，防止多次实例消耗资源，实现单例化。</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="com">// Does the class exist?  If so, we're done...</span></li><li class="L8"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$_classes</span><span class="pun">[</span><span class="pln">$class</span><span class="pun">]))</span></li><li class="L9"><span class="pln">  </span><span class="pun">{</span></li><li class="L0"><span class="pln">   </span><span class="kwd">return</span><span class="pln"> $_classes</span><span class="pun">[</span><span class="pln">$class</span><span class="pun">];</span><span class="com">//如果已经保存在这里，就返回它。</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  $name </span><span class="pun">=</span><span class="pln"> FALSE</span><span class="pun">;</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">//这里，如果应用目录下有和系统目录下相同的类的话，优先引入应用目录，也就是你自己定义的。</span></li><li class="L6"><span class="pln">  </span><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">array</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">,</span><span class="pln"> BASEPATH</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> $path</span><span class="pun">)</span></li><li class="L7"><span class="pln">  </span><span class="pun">{</span></li><li class="L8"><span class="pln">   </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">file_exists</span><span class="pun">(</span><span class="pln">$path</span><span class="pun">.</span><span class="pln">$directory</span><span class="pun">.</span><span class="str">'/'</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">))</span></li><li class="L9"><span class="pln">   </span><span class="pun">{</span></li><li class="L0"><span class="pln">    $name </span><span class="pun">=</span><span class="pln"> $prefix</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">;</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">class_exists</span><span class="pun">(</span><span class="pln">$name</span><span class="pun">)</span><span class="pln"> </span><span class="pun">===</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L3"><span class="pln">    </span><span class="pun">{</span></li><li class="L4"><span class="pln">     </span><span class="kwd">require</span><span class="pun">(</span><span class="pln">$path</span><span class="pun">.</span><span class="pln">$directory</span><span class="pun">.</span><span class="str">'/'</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">);</span></li><li class="L5"><span class="pln">    </span><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">    </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L8"><span class="pln">   </span><span class="pun">}</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">//这里就用到的前缀扩展，如果在应用目录相应的目录下，有自己写的一些对CI库的扩展，那么我们加载的是它，而不是</span></li><li class="L2"><span class="pln">  </span><span class="com">//原来的。因为我们写的扩展是继承了CI原来的。</span></li><li class="L3"><span class="pln">  </span><span class="com">//所以可以看出，即使是CI的核心组件（core/下面的）我们都可以为之进行扩展。</span></li><li class="L4"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">file_exists</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">.</span><span class="pln">$directory</span><span class="pun">.</span><span class="str">'/'</span><span class="pun">.</span><span class="pln">config_item</span><span class="pun">(</span><span class="str">'subclass_prefix'</span><span class="pun">).</span><span class="pln">$class</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">))</span></li><li class="L5"><span class="pln">  </span><span class="pun">{</span></li><li class="L6"><span class="pln">   $name </span><span class="pun">=</span><span class="pln"> config_item</span><span class="pun">(</span><span class="str">'subclass_prefix'</span><span class="pun">).</span><span class="pln">$class</span><span class="pun">;</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">   </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">class_exists</span><span class="pun">(</span><span class="pln">$name</span><span class="pun">)</span><span class="pln"> </span><span class="pun">===</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L9"><span class="pln">   </span><span class="pun">{</span></li><li class="L0"><span class="pln">    </span><span class="kwd">require</span><span class="pun">(</span><span class="pln">APPPATH</span><span class="pun">.</span><span class="pln">$directory</span><span class="pun">.</span><span class="str">'/'</span><span class="pun">.</span><span class="pln">config_item</span><span class="pun">(</span><span class="str">'subclass_prefix'</span><span class="pun">).</span><span class="pln">$class</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">);</span></li><li class="L1"><span class="pln">   </span><span class="pun">}</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="com">// Did we find the class?</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$name </span><span class="pun">===</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">   </span><span class="com">//这里用的是exit();来提示错误，而不是用show_error();这是因为这个load_class的错误有可能</span></li><li class="L8"><span class="pln">   </span><span class="com">//在加载Exception组件之前发。</span></li><li class="L9"><span class="pln">   </span><span class="kwd">exit</span><span class="pun">(</span><span class="str">'Unable to locate the specified class: '</span><span class="pun">.</span><span class="pln">$class</span><span class="pun">.</span><span class="str">'.php'</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">// Keep track of what we just loaded</span></li><li class="L3"><span class="pln">  </span><span class="com">//这个函数只是用来记录已经被加载过的类的类名而已。</span></li><li class="L4"><span class="pln">  is_loaded</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  $_classes</span><span class="pun">[</span><span class="pln">$class</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> $name</span><span class="pun">();</span></li><li class="L7"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $_classes</span><span class="pun">[</span><span class="pln">$class</span><span class="pun">];</span></li><li class="L8"><span class="pln"> </span><span class="pun">}</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">// --------------------------------------------------------------------</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">/**</span></li><li class="L4"><span class="com">* Keeps track of which libraries have been loaded.  This function is</span></li><li class="L5"><span class="com">* called by the load_class() function above</span></li><li class="L6"><span class="com">*/</span></li><li class="L7"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> function_exists</span><span class="pun">(</span><span class="str">'is_loaded'</span><span class="pun">))</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln"> </span><span class="com">//记录有哪些类是已经被加载的。</span></li><li class="L0"><span class="pln"> </span><span class="kwd">function</span><span class="pln"> is_loaded</span><span class="pun">(</span><span class="pln">$class </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">)</span></li><li class="L1"><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="kwd">static</span><span class="pln"> $_is_loaded </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$class </span><span class="pun">!=</span><span class="pln"> </span><span class="str">''</span><span class="pun">)</span></li><li class="L5"><span class="pln">  </span><span class="pun">{</span></li><li class="L6"><span class="pln">   $_is_loaded</span><span class="pun">[</span><span class="pln">strtolower</span><span class="pun">(</span><span class="pln">$class</span><span class="pun">)]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> $class</span><span class="pun">;</span></li><li class="L7"><span class="pln">  </span><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $_is_loaded</span><span class="pun">;</span></li><li class="L0"><span class="pln"> </span><span class="pun">}</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">// ------------------------------------------------------------------------</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/**</span></li><li class="L6"><span class="com">* Loads the main config.php file</span></li><li class="L7"><span class="com">*/</span></li><li class="L8"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> function_exists</span><span class="pun">(</span><span class="str">'get_config'</span><span class="pun">))</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln"> </span><span class="com">//这个是读取配置信息的函数，在Config类被实例化之前，由它暂负责。</span></li><li class="L1"><span class="pln"> </span><span class="com">//而在Config类被实例化之前，我们需要读取的配置信息，其实仅仅是config.php这个主配置文件的。所以这个方法是不能读出</span></li><li class="L2"><span class="pln"> </span><span class="com">//config/下其它配置文件的信息的。</span></li><li class="L3"><span class="pln"> </span><span class="com">//这个$replace参数，是提供一个临时替换配置信息的机会，仅一次，因为执行一次后，配置信息都会保存在静态变量$_config中，不能</span></li><li class="L4"><span class="pln"> </span><span class="com">//改变。</span></li><li class="L5"><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">get_config</span><span class="pun">(</span><span class="pln">$replace </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">())</span></li><li class="L6"><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">  </span><span class="kwd">static</span><span class="pln"> $_config</span><span class="pun">;</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$_config</span><span class="pun">))</span></li><li class="L0"><span class="pln">  </span><span class="pun">{</span></li><li class="L1"><span class="pln">   </span><span class="kwd">return</span><span class="pln"> $_config</span><span class="pun">[</span><span class="lit">0</span><span class="pun">];</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="com">// Is the config file in the environment folder?</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> </span><span class="kwd">defined</span><span class="pun">(</span><span class="str">'ENVIRONMENT'</span><span class="pun">)</span><span class="pln"> OR </span><span class="pun">!</span><span class="pln"> file_exists</span><span class="pun">(</span><span class="pln">$file_path </span><span class="pun">=</span><span class="pln"> APPPATH</span><span class="pun">.</span><span class="str">'config/'</span><span class="pun">.</span><span class="pln">ENVIRONMENT</span><span class="pun">.</span><span class="str">'/config.php'</span><span class="pun">))</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">   $file_path </span><span class="pun">=</span><span class="pln"> APPPATH</span><span class="pun">.</span><span class="str">'config/config.php'</span><span class="pun">;</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Fetch the config file</span></li><li class="L1"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> file_exists</span><span class="pun">(</span><span class="pln">$file_path</span><span class="pun">))</span></li><li class="L2"><span class="pln">  </span><span class="pun">{</span></li><li class="L3"><span class="pln">   </span><span class="kwd">exit</span><span class="pun">(</span><span class="str">'The configuration file does not exist.'</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="kwd">require</span><span class="pun">(</span><span class="pln">$file_path</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">// Does the $config array exist in the file?</span></li><li class="L9"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> isset</span><span class="pun">(</span><span class="pln">$config</span><span class="pun">)</span><span class="pln"> OR </span><span class="pun">!</span><span class="pln"> is_array</span><span class="pun">(</span><span class="pln">$config</span><span class="pun">))</span></li><li class="L0"><span class="pln">  </span><span class="pun">{</span></li><li class="L1"><span class="pln">   </span><span class="kwd">exit</span><span class="pun">(</span><span class="str">'Your config file does not appear to be formatted correctly.'</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="com">// Are any values being dynamically replaced?</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">count</span><span class="pun">(</span><span class="pln">$replace</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">   </span><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$replace </span><span class="kwd">as</span><span class="pln"> $key </span><span class="pun">=&gt;</span><span class="pln"> $val</span><span class="pun">)</span></li><li class="L8"><span class="pln">   </span><span class="pun">{</span></li><li class="L9"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$config</span><span class="pun">[</span><span class="pln">$key</span><span class="pun">]))</span></li><li class="L0"><span class="pln">    </span><span class="pun">{</span></li><li class="L1"><span class="pln">     $config</span><span class="pun">[</span><span class="pln">$key</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> $val</span><span class="pun">;</span></li><li class="L2"><span class="pln">    </span><span class="pun">}</span></li><li class="L3"><span class="pln">   </span><span class="pun">}</span></li><li class="L4"><span class="pln">  </span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $_config</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=&amp;</span><span class="pln"> $config</span><span class="pun">;</span></li><li class="L7"><span class="pln"> </span><span class="pun">}</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">// ------------------------------------------------------------------------</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">/**</span></li><li class="L3"><span class="com">* Returns the specified config item</span></li><li class="L4"><span class="com">*/</span></li><li class="L5"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> function_exists</span><span class="pun">(</span><span class="str">'config_item'</span><span class="pun">))</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln"> </span><span class="com">//取得配置数组中某个元素。</span></li><li class="L8"><span class="pln"> </span><span class="kwd">function</span><span class="pln"> config_item</span><span class="pun">(</span><span class="pln">$item</span><span class="pun">)</span></li><li class="L9"><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">  </span><span class="kwd">static</span><span class="pln"> $_config_item </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> isset</span><span class="pun">(</span><span class="pln">$_config_item</span><span class="pun">[</span><span class="pln">$item</span><span class="pun">]))</span></li><li class="L3"><span class="pln">  </span><span class="pun">{</span></li><li class="L4"><span class="pln">   $config </span><span class="pun">=&amp;</span><span class="pln"> get_config</span><span class="pun">();</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">   </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> isset</span><span class="pun">(</span><span class="pln">$config</span><span class="pun">[</span><span class="pln">$item</span><span class="pun">]))</span></li><li class="L7"><span class="pln">   </span><span class="pun">{</span></li><li class="L8"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> FALSE</span><span class="pun">;</span></li><li class="L9"><span class="pln">   </span><span class="pun">}</span></li><li class="L0"><span class="pln">   $_config_item</span><span class="pun">[</span><span class="pln">$item</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> $config</span><span class="pun">[</span><span class="pln">$item</span><span class="pun">];</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $_config_item</span><span class="pun">[</span><span class="pln">$item</span><span class="pun">];</span></li><li class="L4"><span class="pln"> </span><span class="pun">}</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">// ------------------------------------------------------------------------</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">/**</span></li><li class="L0"><span class="com">* Error Handler</span></li><li class="L1"><span class="com">*/</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">//这里的show_error和下面的show_404以及 _exception_handler这三个错误的处理，实质都是由Exception组件完成的。</span></li><li class="L4"><span class="com">//详见core/Exception.php.</span></li><li class="L5"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> function_exists</span><span class="pun">(</span><span class="str">'show_error'</span><span class="pun">))</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln"> </span><span class="kwd">function</span><span class="pln"> show_error</span><span class="pun">(</span><span class="pln">$message</span><span class="pun">,</span><span class="pln"> $status_code </span><span class="pun">=</span><span class="pln"> </span><span class="lit">500</span><span class="pun">,</span><span class="pln"> $heading </span><span class="pun">=</span><span class="pln"> </span><span class="str">'An Error Was Encountered'</span><span class="pun">)</span></li><li class="L9"><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">  $_error </span><span class="pun">=&amp;</span><span class="pln"> load_class</span><span class="pun">(</span><span class="str">'Exceptions'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'core'</span><span class="pun">);</span></li><li class="L1"><span class="pln">  echo $_error</span><span class="pun">-&gt;</span><span class="pln">show_error</span><span class="pun">(</span><span class="pln">$heading</span><span class="pun">,</span><span class="pln"> $message</span><span class="pun">,</span><span class="pln"> </span><span class="str">'error_general'</span><span class="pun">,</span><span class="pln"> $status_code</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="kwd">exit</span><span class="pun">;</span></li><li class="L3"><span class="pln"> </span><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// ------------------------------------------------------------------------</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/**</span></li><li class="L9"><span class="com">* 404 Page Handler</span></li><li class="L0"><span class="com">*/</span></li><li class="L1"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> function_exists</span><span class="pun">(</span><span class="str">'show_404'</span><span class="pun">))</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln"> </span><span class="kwd">function</span><span class="pln"> show_404</span><span class="pun">(</span><span class="pln">$page </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> $log_error </span><span class="pun">=</span><span class="pln"> TRUE</span><span class="pun">)</span></li><li class="L5"><span class="pln"> </span><span class="pun">{</span></li><li class="L6"><span class="pln">  $_error </span><span class="pun">=&amp;</span><span class="pln"> load_class</span><span class="pun">(</span><span class="str">'Exceptions'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'core'</span><span class="pun">);</span></li><li class="L7"><span class="pln">  $_error</span><span class="pun">-&gt;</span><span class="pln">show_404</span><span class="pun">(</span><span class="pln">$page</span><span class="pun">,</span><span class="pln"> $log_error</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="kwd">exit</span><span class="pun">;</span></li><li class="L9"><span class="pln"> </span><span class="pun">}</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">// ------------------------------------------------------------------------</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/**</span></li><li class="L5"><span class="com">* Error Logging Interface</span></li><li class="L6"><span class="com">*/</span></li><li class="L7"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> function_exists</span><span class="pun">(</span><span class="str">'log_message'</span><span class="pun">))</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln"> </span><span class="kwd">function</span><span class="pln"> log_message</span><span class="pun">(</span><span class="pln">$level </span><span class="pun">=</span><span class="pln"> </span><span class="str">'error'</span><span class="pun">,</span><span class="pln"> $message</span><span class="pun">,</span><span class="pln"> $php_error </span><span class="pun">=</span><span class="pln"> FALSE</span><span class="pun">)</span></li><li class="L0"><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">  </span><span class="kwd">static</span><span class="pln"> $_log</span><span class="pun">;</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">config_item</span><span class="pun">(</span><span class="str">'log_threshold'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></li><li class="L4"><span class="pln">  </span><span class="pun">{</span></li><li class="L5"><span class="pln">   </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L6"><span class="pln">  </span><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  $_log </span><span class="pun">=&amp;</span><span class="pln"> load_class</span><span class="pun">(</span><span class="str">'Log'</span><span class="pun">);</span></li><li class="L9"><span class="pln">  $_log</span><span class="pun">-&gt;</span><span class="pln">write_log</span><span class="pun">(</span><span class="pln">$level</span><span class="pun">,</span><span class="pln"> $message</span><span class="pun">,</span><span class="pln"> $php_error</span><span class="pun">);</span></li><li class="L0"><span class="pln"> </span><span class="pun">}</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">// ------------------------------------------------------------------------</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/**</span></li><li class="L6"><span class="com"> * Set HTTP Status Header</span></li><li class="L7"><span class="com"> */</span></li><li class="L8"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> function_exists</span><span class="pun">(</span><span class="str">'set_status_header'</span><span class="pun">))</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln"> </span><span class="kwd">function</span><span class="pln"> set_status_header</span><span class="pun">(</span><span class="pln">$code </span><span class="pun">=</span><span class="pln"> </span><span class="lit">200</span><span class="pun">,</span><span class="pln"> $text </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">)</span></li><li class="L1"><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="com">//此函数构造一个响应头。$stati为响应码与其响应说明。</span></li><li class="L3"><span class="pln">  $stati </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">(</span></li><li class="L4"><span class="pln">       </span><span class="lit">200</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'OK'</span><span class="pun">,</span></li><li class="L5"><span class="pln">       </span><span class="lit">201</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Created'</span><span class="pun">,</span></li><li class="L6"><span class="pln">       </span><span class="lit">202</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Accepted'</span><span class="pun">,</span></li><li class="L7"><span class="pln">       </span><span class="lit">203</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Non-Authoritative Information'</span><span class="pun">,</span></li><li class="L8"><span class="pln">       </span><span class="lit">204</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'No Content'</span><span class="pun">,</span></li><li class="L9"><span class="pln">       </span><span class="lit">205</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Reset Content'</span><span class="pun">,</span></li><li class="L0"><span class="pln">       </span><span class="lit">206</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Partial Content'</span><span class="pun">,</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">       </span><span class="lit">300</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Multiple Choices'</span><span class="pun">,</span></li><li class="L3"><span class="pln">       </span><span class="lit">301</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Moved Permanently'</span><span class="pun">,</span></li><li class="L4"><span class="pln">       </span><span class="lit">302</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Found'</span><span class="pun">,</span></li><li class="L5"><span class="pln">       </span><span class="lit">304</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Not Modified'</span><span class="pun">,</span></li><li class="L6"><span class="pln">       </span><span class="lit">305</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Use Proxy'</span><span class="pun">,</span></li><li class="L7"><span class="pln">       </span><span class="lit">307</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Temporary Redirect'</span><span class="pun">,</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">       </span><span class="lit">400</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Bad Request'</span><span class="pun">,</span></li><li class="L0"><span class="pln">       </span><span class="lit">401</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Unauthorized'</span><span class="pun">,</span></li><li class="L1"><span class="pln">       </span><span class="lit">403</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Forbidden'</span><span class="pun">,</span></li><li class="L2"><span class="pln">       </span><span class="lit">404</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Not Found'</span><span class="pun">,</span></li><li class="L3"><span class="pln">       </span><span class="lit">405</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Method Not Allowed'</span><span class="pun">,</span></li><li class="L4"><span class="pln">       </span><span class="lit">406</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Not Acceptable'</span><span class="pun">,</span></li><li class="L5"><span class="pln">       </span><span class="lit">407</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Proxy Authentication Required'</span><span class="pun">,</span></li><li class="L6"><span class="pln">       </span><span class="lit">408</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Request Timeout'</span><span class="pun">,</span></li><li class="L7"><span class="pln">       </span><span class="lit">409</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Conflict'</span><span class="pun">,</span></li><li class="L8"><span class="pln">       </span><span class="lit">410</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Gone'</span><span class="pun">,</span></li><li class="L9"><span class="pln">       </span><span class="lit">411</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Length Required'</span><span class="pun">,</span></li><li class="L0"><span class="pln">       </span><span class="lit">412</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Precondition Failed'</span><span class="pun">,</span></li><li class="L1"><span class="pln">       </span><span class="lit">413</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Request Entity Too Large'</span><span class="pun">,</span></li><li class="L2"><span class="pln">       </span><span class="lit">414</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Request-URI Too Long'</span><span class="pun">,</span></li><li class="L3"><span class="pln">       </span><span class="lit">415</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Unsupported Media Type'</span><span class="pun">,</span></li><li class="L4"><span class="pln">       </span><span class="lit">416</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Requested Range Not Satisfiable'</span><span class="pun">,</span></li><li class="L5"><span class="pln">       </span><span class="lit">417</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Expectation Failed'</span><span class="pun">,</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">       </span><span class="lit">500</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Internal Server Error'</span><span class="pun">,</span></li><li class="L8"><span class="pln">       </span><span class="lit">501</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Not Implemented'</span><span class="pun">,</span></li><li class="L9"><span class="pln">       </span><span class="lit">502</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Bad Gateway'</span><span class="pun">,</span></li><li class="L0"><span class="pln">       </span><span class="lit">503</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Service Unavailable'</span><span class="pun">,</span></li><li class="L1"><span class="pln">       </span><span class="lit">504</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Gateway Timeout'</span><span class="pun">,</span></li><li class="L2"><span class="pln">       </span><span class="lit">505</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'HTTP Version Not Supported'</span></li><li class="L3"><span class="pln">      </span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">//如果调用此函数本身出错，则发出一个错误。</span></li><li class="L6"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$code </span><span class="pun">==</span><span class="pln"> </span><span class="str">''</span><span class="pln"> OR </span><span class="pun">!</span><span class="pln"> is_numeric</span><span class="pun">(</span><span class="pln">$code</span><span class="pun">))</span></li><li class="L7"><span class="pln">  </span><span class="pun">{</span></li><li class="L8"><span class="pln">   show_error</span><span class="pun">(</span><span class="str">'Status codes must be numeric'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">500</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$stati</span><span class="pun">[</span><span class="pln">$code</span><span class="pun">])</span><span class="pln"> AND $text </span><span class="pun">==</span><span class="pln"> </span><span class="str">''</span><span class="pun">)</span></li><li class="L2"><span class="pln">  </span><span class="pun">{</span></li><li class="L3"><span class="pln">   $text </span><span class="pun">=</span><span class="pln"> $stati</span><span class="pun">[</span><span class="pln">$code</span><span class="pun">];</span></li><li class="L4"><span class="pln">  </span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">//如果$text为空，一般是因为调用此函数时，给的响应码不正确同时又没有写出响应报文信息。</span></li><li class="L7"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$text </span><span class="pun">==</span><span class="pln"> </span><span class="str">''</span><span class="pun">)</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">   show_error</span><span class="pun">(</span><span class="str">'No status text available.  Please check your status code number or supply your own message text.'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">500</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">//取得当前协议。</span></li><li class="L3"><span class="pln">  $server_protocol </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="pln">$_SERVER</span><span class="pun">[</span><span class="str">'SERVER_PROTOCOL'</span><span class="pun">]))</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> $_SERVER</span><span class="pun">[</span><span class="str">'SERVER_PROTOCOL'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> FALSE</span><span class="pun">;</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">//php_sapi_name()方法可以获得PHP与服务器之间的接口类型，</span></li><li class="L6"><span class="pln">  </span><span class="com">//下面是以cgi类型和以服务器模块形式类型的不同发出响应的方式。</span></li><li class="L7"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">substr</span><span class="pun">(</span><span class="pln">php_sapi_name</span><span class="pun">(),</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">3</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'cgi'</span><span class="pun">)</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">   header</span><span class="pun">(</span><span class="str">"Status: {$code} {$text}"</span><span class="pun">,</span><span class="pln"> TRUE</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pln">  elseif </span><span class="pun">(</span><span class="pln">$server_protocol </span><span class="pun">==</span><span class="pln"> </span><span class="str">'HTTP/1.1'</span><span class="pln"> OR $server_protocol </span><span class="pun">==</span><span class="pln"> </span><span class="str">'HTTP/1.0'</span><span class="pun">)</span></li><li class="L2"><span class="pln">  </span><span class="pun">{</span></li><li class="L3"><span class="pln">   header</span><span class="pun">(</span><span class="pln">$server_protocol</span><span class="pun">.</span><span class="str">" {$code} {$text}"</span><span class="pun">,</span><span class="pln"> TRUE</span><span class="pun">,</span><span class="pln"> $code</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="pun">}</span></li><li class="L5"><span class="pln">  </span><span class="kwd">else</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">   header</span><span class="pun">(</span><span class="str">"HTTP/1.1 {$code} {$text}"</span><span class="pun">,</span><span class="pln"> TRUE</span><span class="pun">,</span><span class="pln"> $code</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pln"> </span><span class="pun">}</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">// --------------------------------------------------------------------</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/**</span></li><li class="L5"><span class="com">* Exception Handler</span></li><li class="L6"><span class="com">*/</span></li><li class="L7"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> function_exists</span><span class="pun">(</span><span class="str">'_exception_handler'</span><span class="pun">))</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln"> </span><span class="com">//在CodeIgniter.php中执行set_error_handler('_exception_handler');后，以后一切非致命(非fatal)错误信息都由它处理。</span></li><li class="L0"><span class="pln"> </span><span class="com">//触发错误的时候，会产生几个参数，错误级别（号），错误信息，错误文件，错误行。</span></li><li class="L1"><span class="pln"> </span><span class="kwd">function</span><span class="pln"> _exception_handler</span><span class="pun">(</span><span class="pln">$severity</span><span class="pun">,</span><span class="pln"> $message</span><span class="pun">,</span><span class="pln"> $filepath</span><span class="pun">,</span><span class="pln"> $line</span><span class="pun">)</span></li><li class="L2"><span class="pln"> </span><span class="pun">{</span></li><li class="L3"><span class="pln">   </span><span class="com">/**</span></li><li class="L4"><span class="com">    * 有关错误等级的内容可看：http://blog.163.com/wu_guoqing/blog/static/19653701820127269312682/</span></li><li class="L5"><span class="com">    * E_STRICT对于大多数情况来说都是没多大作用的错误提示，这里CI把它屏蔽掉，如果实在要查看，可以查看日志文件。</span></li><li class="L6"><span class="com">    */</span></li><li class="L7"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$severity </span><span class="pun">==</span><span class="pln"> E_STRICT</span><span class="pun">)</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">   </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">//真正起到错误处理的是Exception组件。</span></li><li class="L3"><span class="pln">  $_error </span><span class="pun">=&amp;</span><span class="pln"> load_class</span><span class="pun">(</span><span class="str">'Exceptions'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'core'</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">/*</span></li><li class="L6"><span class="com">   * 注意下面的符号是&amp;而不是&amp;&amp;，php的错误等级的值都是有规律的，例如1,2,4,8...（1,10,100,1000）等等，实际上，php是通过位运算来实现的，</span></li><li class="L7"><span class="com">   * 使得错误控制更精准。（类似linux的权限控制，rwx）</span></li><li class="L8"><span class="com">   * 在设置error_reporting()的时候，可通过E_XX|E_YY|E_ZZ的形式来设置，而判断的时候则通过E_XX&amp;error_repoorting()来判断</span></li><li class="L9"><span class="com">   * E_XX有没有设置。例如1,10,100,1000相或|，则值为1111,则以后1,10,100,1000中任意一个与1111相&amp;,值都为它本身。</span></li><li class="L0"><span class="com">   * 而E_ALL可以看到是除E_STRICT之外其它等级的“或(|)运算”。个人理解，之所以E_ALL的值是不同版本有所不同的，是</span></li><li class="L1"><span class="com">   * 因为有时候会加入新的错误级别，从而导致这个E_ALL的值也不一样。</span></li><li class="L2"><span class="com">   */</span></li><li class="L3"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">$severity </span><span class="pun">&amp;</span><span class="pln"> error_reporting</span><span class="pun">())</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> $severity</span><span class="pun">)</span></li><li class="L4"><span class="pln">  </span><span class="pun">{</span></li><li class="L5"><span class="pln">   </span><span class="com">//如果符合则交给Exception组件的show_php_error();进行处理。</span></li><li class="L6"><span class="pln">   $_error</span><span class="pun">-&gt;</span><span class="pln">show_php_error</span><span class="pun">(</span><span class="pln">$severity</span><span class="pun">,</span><span class="pln"> $message</span><span class="pun">,</span><span class="pln"> $filepath</span><span class="pun">,</span><span class="pln"> $line</span><span class="pun">);</span></li><li class="L7"><span class="pln">  </span><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="com">//下面两行只是根据配置文件判断要不要log错误信息而已。</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">config_item</span><span class="pun">(</span><span class="str">'log_threshold'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></li><li class="L2"><span class="pln">  </span><span class="pun">{</span></li><li class="L3"><span class="pln">   </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L4"><span class="pln">  </span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  $_error</span><span class="pun">-&gt;</span><span class="pln">log_exception</span><span class="pun">(</span><span class="pln">$severity</span><span class="pun">,</span><span class="pln"> $message</span><span class="pun">,</span><span class="pln"> $filepath</span><span class="pun">,</span><span class="pln"> $line</span><span class="pun">);</span></li><li class="L7"><span class="pln"> </span><span class="pun">}</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">// --------------------------------------------------------------------</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">/**</span></li><li class="L3"><span class="com"> * Remove Invisible Characters</span></li><li class="L4"><span class="com"> */</span></li><li class="L5"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> function_exists</span><span class="pun">(</span><span class="str">'remove_invisible_characters'</span><span class="pun">))</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln"> </span><span class="kwd">function</span><span class="pln"> remove_invisible_characters</span><span class="pun">(</span><span class="pln">$str</span><span class="pun">,</span><span class="pln"> $url_encoded </span><span class="pun">=</span><span class="pln"> TRUE</span><span class="pun">)</span></li><li class="L8"><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">  $non_displayables </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// every control character except newline (dec 10)</span></li><li class="L2"><span class="pln">  </span><span class="com">// carriage return (dec 13), and horizontal tab (dec 09)</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$url_encoded</span><span class="pun">)</span></li><li class="L5"><span class="pln">  </span><span class="pun">{</span></li><li class="L6"><span class="pln">   $non_displayables</span><span class="pun">[]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="str">'/%0[0-8bcef]/'</span><span class="pun">;</span><span class="pln"> </span><span class="com">// url encoded 00-08, 11, 12, 14, 15</span></li><li class="L7"><span class="pln">   $non_displayables</span><span class="pun">[]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="str">'/%1[0-9a-f]/'</span><span class="pun">;</span><span class="pln"> </span><span class="com">// url encoded 16-31</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  $non_displayables</span><span class="pun">[]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="str">'/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]+/S'</span><span class="pun">;</span><span class="pln"> </span><span class="com">// 00-08, 11, 12, 14-31, 127</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="kwd">do</span></li><li class="L3"><span class="pln">  </span><span class="pun">{</span></li><li class="L4"><span class="pln">   $str </span><span class="pun">=</span><span class="pln"> preg_replace</span><span class="pun">(</span><span class="pln">$non_displayables</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> $str</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> $count</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="pun">}</span></li><li class="L6"><span class="pln">  </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$count</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $str</span><span class="pun">;</span></li><li class="L9"><span class="pln"> </span><span class="pun">}</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">// ------------------------------------------------------------------------</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/**</span></li><li class="L5"><span class="com">* Returns HTML escaped variable</span></li><li class="L6"><span class="com">*/</span></li><li class="L7"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> function_exists</span><span class="pun">(</span><span class="str">'html_escape'</span><span class="pun">))</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln"> </span><span class="kwd">function</span><span class="pln"> html_escape</span><span class="pun">(</span><span class="pln">$var</span><span class="pun">)</span></li><li class="L0"><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">is_array</span><span class="pun">(</span><span class="pln">$var</span><span class="pun">))</span></li><li class="L2"><span class="pln">  </span><span class="pun">{</span></li><li class="L3"><span class="pln">   </span><span class="kwd">return</span><span class="pln"> array_map</span><span class="pun">(</span><span class="str">'html_escape'</span><span class="pun">,</span><span class="pln"> $var</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="pun">}</span></li><li class="L5"><span class="pln">  </span><span class="kwd">else</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">   </span><span class="kwd">return</span><span class="pln"> htmlspecialchars</span><span class="pun">(</span><span class="pln">$var</span><span class="pun">,</span><span class="pln"> ENT_QUOTES</span><span class="pun">,</span><span class="pln"> config_item</span><span class="pun">(</span><span class="str">'charset'</span><span class="pun">));</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pln"> </span><span class="pun">}</span></li><li class="L0"><span class="pun">}</span></li></ol></pre>
<p>转载请注明：<a href="http://calixwu.com/" data-original-title="" title="">Calix</a> » <a href="./CodeIgniter源码分析之Common.php – Calix的博客_files/CodeIgniter源码分析之Common.php – Calix的博客.html" data-original-title="" title="">CodeIgniter源码分析之Common.php</a></p>

      
<div class="article-social">
			<a href="javascript:;" data-action="ding" data-id="34" id="Addlike" class="action" data-original-title="" title=""><i class="fa fa-heart-o"></i>喜欢 (<span class="count">2</span>)</a><span class="or">or</span><span class="action action-share bdsharebuttonbox bdshare-button-style0-24" data-bd-bind="1467156951152"><i class="fa fa-share-alt"></i>分享 (<span class="bds_count" data-cmd="count" title="累计分享0次">0</span>)<div class="action-popover"><div class="popover top in"><div class="arrow"></div><div class="popover-content"><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-common-php.html#" class="sinaweibo fa fa-weibo" data-cmd="tsina" title="" data-original-title="分享到新浪微博"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-common-php.html#" class="bds_qzone fa fa-star" data-cmd="qzone" title="" data-original-title="分享到QQ空间"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-common-php.html#" class="tencentweibo fa fa-tencent-weibo" data-cmd="tqq" title="" data-original-title="分享到腾讯微博"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-common-php.html#" class="qq fa fa-qq" data-cmd="sqq" title="" data-original-title="分享到QQ好友"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-common-php.html#" class="bds_renren fa fa-renren" data-cmd="renren" title="" data-original-title="分享到人人网"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-common-php.html#" class="bds_weixin fa fa-weixin" data-cmd="weixin" title="" data-original-title="分享到微信"></a><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-common-php.html#" class="bds_more fa fa-ellipsis-h" data-cmd="more" data-original-title="" title=""></a></div></div></div></span>	
</div>
	</article>	
				<footer class="article-footer">
			<div class="article-tags"><i class="fa fa-tags"></i><a href="http://calixwu.com/tag/codeigniter" rel="tag" data-original-title="" title="">CodeIgniter</a><a href="http://calixwu.com/tag/mvc" rel="tag" data-original-title="" title="">MVC</a><a href="http://calixwu.com/tag/%e6%a1%86%e6%9e%b6" rel="tag" data-original-title="" title="">框架</a><a href="http://calixwu.com/tag/%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" rel="tag" data-original-title="" title="">源码分析</a></div></footer>
	<nav class="article-nav">
			<span class="article-nav-prev"><i class="fa fa-angle-double-left"></i> <a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-uri-php.html" rel="prev">CodeIgniter源码分析之URI.php</a></span>
			<span class="article-nav-next"><a href="http://calixwu.com/2014/11/codeigniter-yuanmafenxi-codeigniter-php.html" rel="next">CodeIgniter源码分析之CodeIgniter.php</a>  <i class="fa fa-angle-double-right"></i></span>
		</nav>

		<div class="related_top">
			<div class="related_posts">

<div class="relates">
<ul>
<li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi.html">Memcached源码分析</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-from-set.html">Memcached源码分析之从SET命令开始说起</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-xianchengmoxing.html">Memcached源码分析之线程模型</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-qingqiuchuli-zhuangtaiji.html">Memcached源码分析之请求处理（状态机）</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-neicunguanli.html">Memcached源码分析之内存管理</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-memcached-h.html">Memcached源码分析之memcached.h</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-memcached-c.html">Memcached源码分析之memcached.c</a></li><li><i class="fa fa-minus"></i><a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-thread-c.html">Memcached源码分析之thread.c</a></li>
</ul></div></div>		</div>
						<div id="respond" class="no_webshot">
		<form action="http://calixwu.com/wp-comments-post.php" method="post" id="commentform">
		
		<div class="comt-title">
			<div class="comt-avatar pull-left">
				<img src="./CodeIgniter源码分析之Common.php – Calix的博客_files/m32.gif" class="avatar avatar-0" height="54px" width="54px">			</div>
			<div class="comt-author pull-left">
			发表我的评论			</div>
			<a id="cancel-comment-reply-link" class="pull-right" href="javascript:;">取消评论</a>
		</div>
		
		<div class="comt">
			<div class="comt-box">
				<textarea placeholder="写点什么..." class="input-block-level comt-area" name="comment" id="comment" cols="100%" rows="3" tabindex="1" onkeydown="if(event.ctrlKey&amp;&amp;event.keyCode==13){document.getElementById(&#39;submit&#39;).click();return false};"></textarea>
				<div class="comt-ctrl">
					<button class="btn btn-primary pull-right" type="submit" name="submit" id="submit" tabindex="5"><i class="fa fa-check-square-o"></i> 提交评论</button>
					<div class="comt-tips pull-right"><input type="hidden" name="comment_post_ID" value="34" id="comment_post_ID">
<input type="hidden" name="comment_parent" id="comment_parent" value="0">
<div class="comt-tip comt-loading" style="display: none;">正在提交, 请稍候...</div><div class="comt-tip comt-error" style="display: none;">#</div></div>
					<span data-type="comment-insert-smilie" class="muted comt-smilie"><i class="fa fa-smile-o"></i> 表情</span>
					<span class="muted comt-mailme"><label for="comment_mail_notify" class="checkbox inline" style="padding-top:0"><input type="checkbox" name="comment_mail_notify" id="comment_mail_notify" value="comment_mail_notify" checked="checked">有人回复时邮件通知我</label></span>
				</div>
			</div>

												<div class="comt-comterinfo" id="comment-author-info">
						<h4>亲~ 写下昵称哦~</h4>
						<ul>
							<li class="form-inline"><label class="hide" for="author">昵称</label><input class="ipt" type="text" name="author" id="author" value="" tabindex="2" placeholder="昵称"><span class="help-inline">昵称 (必填)</span></li>
						<!--	<li class="form-inline"><label class="hide" for="email">邮箱</label><input class="ipt" type="text" name="email" id="email" value="" tabindex="3" placeholder="邮箱"><span class="help-inline">邮箱 (必填)</span></li> -->
							<li class="form-inline"><label class="hide" for="url">网址</label><input class="ipt" type="text" name="url" id="url" value="" tabindex="4" placeholder="网址"><span class="help-inline">网址</span></li> 
						</ul>
					</div>
									</div>

		
	</form>
	</div>
<div id="postcomments">
	<div id="comments">
		<i class="fa fa-comments-o"></i> <b> (1)</b>个小伙伴在吐槽
	</div>
	<ol class="commentlist">
			</ol>
	<div class="commentnav">
			</div>
</div>
			</div>
</div>
<aside class="sidebar">	
<div class="widget widget_text"><div class="textwidget"><div class="social">
<a href="http://calixwu.com/feed" rel="external nofollow" target="_blank" title="" data-original-title="订阅本站"><i class="rss fa fa-rss"></i></a></div></div></div>

		<div class="widget widget_recent_entries">		<div class="title"><h2>近期文章</h2></div>		<ul>
					<li>
				<a href="http://calixwu.com/2014/11/memcached-yuanmafenxi.html">Memcached源码分析</a>
						</li>
					<li>
				<a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-from-set.html">Memcached源码分析之从SET命令开始说起</a>
						</li>
					<li>
				<a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-xianchengmoxing.html">Memcached源码分析之线程模型</a>
						</li>
					<li>
				<a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-qingqiuchuli-zhuangtaiji.html">Memcached源码分析之请求处理（状态机）</a>
						</li>
					<li>
				<a href="http://calixwu.com/2014/11/memcached-yuanmafenxi-neicunguanli.html">Memcached源码分析之内存管理</a>
						</li>
				</ul>
		</div><div class="widget widget_categories"><div class="title"><h2>分类目录</h2></div>		<ul>
	<li class="cat-item cat-item-4"><a href="http://calixwu.com/category/codeigniter">CodeIgniter</a>
</li>
	<li class="cat-item cat-item-3"><a href="http://calixwu.com/category/memcached">Memcached</a>
</li>
		</ul>
</div></aside>
</section>
<footer class="footer">
    <div class="footer-inner">
        <div class="copyright pull-left">
        	<a href="http://calixwu.com/" title="Calix的博客">Calix的博客</a> 版权所有，保留一切权利 ·   基于<a href="http://cn.wordpress.org/">WordPress</a>构建   © 2014-2015

	</div>
        <div class="trackcode pull-right">
            <script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F77f536717c5f64cbc346960632d9eedb' type='text/javascript'%3E%3C/script%3E"));
</script><script src="./CodeIgniter源码分析之Common.php – Calix的博客_files/h.js" type="text/javascript"></script><a href="http://tongji.baidu.com/hm-web/welcome/ico?s=77f536717c5f64cbc346960632d9eedb" target="_blank"><img border="0" src="./CodeIgniter源码分析之Common.php – Calix的博客_files/21.gif" width="20" height="20"></a>

<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1254487188'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1254487188' type='text/javascript'%3E%3C/script%3E"));</script><span id="cnzz_stat_icon_1254487188"><a href="http://www.cnzz.com/stat/website.php?web_id=1254487188" target="_blank" title="站长统计">站长统计</a></span><script src="./CodeIgniter源码分析之Common.php – Calix的博客_files/z_stat.php" type="text/javascript"></script><script src="./CodeIgniter源码分析之Common.php – Calix的博客_files/core.php" charset="utf-8" type="text/javascript"></script>        </div>
    </div>
</footer>

<script>with(document)0[(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion="+~(-new Date()/36e5)];</script>

<div class="rollto"><button class="btn btn-inverse" data-type="totop" title="回顶部"><i class="fa fa-arrow-up"></i></button><button class="btn btn-inverse" data-type="torespond" title="发评论"><i class="fa fa-comment-o"></i></button></div></body></html>